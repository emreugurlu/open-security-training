<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GRC Engineering: Secure Coding Training</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root {
      --primary-purple:#7B2CBF; --light-purple:#E0B0FF; --dark-purple:#4A1A6B;
      --primary-teal:#06A77D; --light-teal:#B2F5E8; --dark-teal:#045F4A;
      --primary-off-black:#17191E; --primary-white:#FFFFFF; --success-green:#4CAF50;
      --warning-amber:#FF9800; --error-red:#F44336; --neutral-gray:#9E9E9E;
      --light-gray:#F5F5F5; --medium-gray:#E0E0E0; --primary-gradient: linear-gradient(135deg, #7B2CBF 0%, #06A77D 100%);
    }
    
    body { 
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background: #0a0e27;
      color:var(--primary-off-black); 
      min-height:100vh; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      padding:20px; 
      line-height:1.6;
      overflow-x: hidden;
    }
    
    /* Static gradient background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 50%, rgba(123,44,191,0.15) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(123,44,191,0.1) 0%, transparent 50%),
                  radial-gradient(circle at 40% 20%, rgba(0,85,204,0.1) 0%, transparent 50%);
      z-index: -1;
    }
    
    .module-container { 
      background:var(--primary-white); 
      border-radius:16px; 
      box-shadow:0 10px 40px rgba(0,8,77,.25); 
      max-width:1100px; 
      width:100%; 
      overflow:hidden;
    }
    
    .grc-header { 
      background:var(--primary-gradient); 
      padding:20px 32px; 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      color:var(--primary-white);
      position: relative;
      overflow: hidden;
    }
    
    .grc-logo { 
      display:flex; 
      align-items:center; 
      gap:16px; 
      font-weight:700; 
      font-size:20px;
      z-index: 2;
    }
    
    .grc-owl { 
      width:48px; 
      height:48px; 
      background:var(--primary-white); 
      border-radius:12px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      font-size:28px;
      animation: bounce 2s ease-in-out infinite;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .grc-owl:hover {
      transform: rotate(10deg) scale(1.1);
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    
    .progress-bar { 
      height:6px; 
      background:var(--medium-gray); 
      position:relative; 
      overflow:hidden; 
    }
    
    .progress-fill { 
      height:100%; 
      background:var(--primary-gradient); 
      width:0%; 
      transition:width .5s ease;
      box-shadow: 0 0 10px rgba(123,44,191,0.5);
    }
    
    .slide { 
      padding:56px 48px; 
      min-height:580px; 
      display:none; 
      animation:slideIn .4s ease;
      position: relative;
    }
    
    .slide.active { display:block; }
    
    @keyframes slideIn { 
      from{ opacity:0; transform:translateX(30px); } 
      to{ opacity:1; transform:translateX(0); } 
    }
    
    /* Hide slide content briefly during restoration */
    .slide.restoring {
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    h1 { 
      color:var(--dark-purple); 
      font-size:2.5rem; 
      font-weight:800; 
      margin-bottom:24px; 
      text-align:center; 
      line-height:1.2; 
    }
    
    h2 { 
      color:var(--dark-purple); 
      font-size:2rem; 
      font-weight:700; 
      margin-bottom:24px; 
    }
    
    p { 
      font-size:1.125rem; 
      margin-bottom:20px; 
      color:var(--primary-off-black); 
      line-height:1.7;
    }
    
    .intro-animation {
      font-size: 120px;
      text-align: center;
      margin: 40px 0;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    .info-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
      margin: 32px 0;
    }
    
    .info-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid var(--medium-gray);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .info-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      border-color: var(--primary-purple);
    }
    
    .info-card-icon {
      font-size: 48px;
      margin-bottom: 16px;
      display: block;
    }
    
    .info-card h3 {
      color: var(--dark-purple);
      font-size: 1.25rem;
      margin-bottom: 12px;
    }
    
    .navigation { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      margin-top:40px; 
      padding-top:32px; 
      border-top:2px solid var(--medium-gray); 
    }
    
    .btn { 
      background:var(--primary-gradient); 
      color:var(--primary-white); 
      padding:14px 28px; 
      border:none; 
      border-radius:8px; 
      font-size:1rem; 
      font-weight:600; 
      cursor:pointer; 
      transition:all .3s ease; 
      margin:8px; 
      display:inline-flex; 
      align-items:center; 
      gap:8px;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn:hover { 
      transform:translateY(-2px); 
      box-shadow:0 6px 20px rgba(123,44,191,.3); 
    }
    
    .btn-secondary { 
      background:transparent; 
      color:var(--primary-purple); 
      border:2px solid var(--primary-purple); 
    }
    
    .btn-secondary:hover { 
      background:var(--light-purple); 
      border-color:var(--dark-purple); 
      color:var(--dark-purple); 
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ff3b30, #ff6b60);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #4CAF50, #66BB6A);
    }
    
    .btn:disabled, .btn.disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    /* Watering hole simulator */
    .website-simulator {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 0;
      margin: 24px 0;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .browser-bar {
      background: #2d2d2d;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #444;
    }
    
    .browser-controls {
      display: flex;
      gap: 8px;
    }
    
    .browser-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ff5f57;
    }
    
    .browser-dot:nth-child(2) { background: #ffbd2e; }
    .browser-dot:nth-child(3) { background: #28ca42; }
    
    .url-bar {
      flex: 1;
      background: #1a1a1a;
      color: #888;
      padding: 6px 12px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
    }
    
    .suspicious-url {
      color: #ff3b30;
      font-weight: bold;
    }
    
    .website-content {
      background: #fff;
      padding: 32px;
      min-height: 300px;
      position: relative;
    }
    
    .fake-popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      text-align: center;
      display: none;
      z-index: 10;
      border: 3px solid #ff3b30;
    }
    
    .fake-popup.show {
      display: block;
      animation: popIn 0.3s ease;
    }
    
    @keyframes popIn {
      from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    
    /* Interactive decision buttons */
    .decision-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 24px;
      position: relative;
      z-index: 50;
    }
    
    .decision-btn {
      background: #fff;
      border: 2px solid #e0e0e0;
      padding: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      text-align: center;
      position: relative;
    }
    
    .decision-btn:hover {
      background: var(--light-purple);
      border-color: var(--primary-purple);
      box-shadow: 0 4px 12px rgba(123,44,191,0.2);
      transform: translateY(-2px);
    }
    
    .decision-btn.selected {
      background: var(--light-purple);
      border-color: var(--primary-purple);
      font-weight: 600;
    }
    
    .decision-btn.disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    /* Detection challenge */
    .detection-challenge {
      background: #f8f9fa;
      border: 2px solid var(--medium-gray);
      border-radius: 12px;
      padding: 24px;
      margin: 24px 0;
    }
    
    .site-card {
      background: #fff;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin: 12px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .site-card:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .site-card.selected {
      border-color: var(--primary-purple);
      background: var(--light-purple);
    }
    
    .site-card.correct {
      border-color: var(--success-green);
      background: rgba(76,175,80,0.1);
    }
    
    .site-card.incorrect {
      border-color: var(--error-red);
      background: rgba(244,67,54,0.1);
    }
    
    .url-display {
      font-family: monospace;
      font-size: 14px;
      color: #666;
      margin-top: 8px;
      padding: 4px 8px;
      background: #f0f0f0;
      border-radius: 4px;
      display: inline-block;
    }
    
    /* Gamification elements */
    .achievement {
      position: fixed;
      top: 20px;
      right: -500px;
      background: #fff;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 16px;
      transition: right 0.5s ease;
      z-index: 1000;
      pointer-events: none;
    }
    
    .achievement.show {
      right: 20px;
      pointer-events: auto;
    }
    
    .achievement-icon {
      font-size: 32px;
      animation: celebrate 0.5s ease;
    }
    
    @keyframes celebrate {
      0% { transform: scale(0) rotate(0deg); }
      50% { transform: scale(1.2) rotate(180deg); }
      100% { transform: scale(1) rotate(360deg); }
    }
    
    .score-display {
      background: linear-gradient(135deg, #7B2CBF, #06A77D);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 700;
      text-align: center;
      margin: 20px 0;
      font-size: 1.2rem;
      box-shadow: 0 4px 12px rgba(123,44,191,0.3);
    }
    
    /* Certificate */
    .certificate {
      text-align: center;
      padding: 48px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 16px;
      border: 3px solid var(--primary-purple);
      position: relative;
      overflow: hidden;
    }
    
    .certificate::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(123,44,191,0.1), transparent);
      animation: shine 3s linear infinite;
    }
    
    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }
    
    .certificate-seal {
      width: 120px;
      height: 120px;
      margin: 0 auto 24px;
      position: relative;
      animation: sealRotate 20s linear infinite;
    }
    
    @keyframes sealRotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .trophy-icon {
      font-size: 80px;
      color: #FFD700;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      animation: trophyGlow 2s ease-in-out infinite;
    }
    
    @keyframes trophyGlow {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    /* Confetti */
    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 9999;
      display: none;
    }
    
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--primary-purple);
      animation: confettiFall 3s linear;
    }
    
    @keyframes confettiFall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }
    
    @keyframes flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    
    /* SCORM status indicator */
    .scorm-status {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: rgba(23,25,30,.9);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: .75rem;
      display: none;
      backdrop-filter: blur(10px);
    }
    
    /* Feedback styles */
    .feedback {
      padding: 16px;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 16px;
      display: none;
    }
    
    .feedback.correct {
      background: #d4edda;
      color: #155724;
      border: 2px solid var(--success-green);
    }
    
    .feedback.incorrect {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid var(--error-red);
    }
    
    .feedback.warning {
      background: #fff3cd;
      color: #856404;
      border: 2px solid #ffc107;
    }
    
    /* OWASP Top 10 List Styles */
    .owasp-item {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border: 2px solid #dee2e6;
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .owasp-item:hover {
      border-color: var(--primary-purple);
      box-shadow: 0 4px 12px rgba(123,44,191,0.15);
      transform: translateX(4px);
    }
    
    .owasp-item.active {
      background: linear-gradient(135deg, var(--light-purple), #d4e4fc);
      border-color: var(--primary-purple);
    }
    
    .owasp-header {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      gap: 16px;
    }
    
    .owasp-number {
      background: var(--primary-purple);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .owasp-icon {
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .owasp-title {
      flex: 1;
      font-weight: 600;
      color: var(--dark-purple);
      font-size: 16px;
    }
    
    .owasp-arrow {
      color: #6c757d;
      transition: transform 0.3s ease;
      font-size: 14px;
    }
    
    .owasp-item.active .owasp-arrow {
      transform: rotate(90deg);
    }
    
    .owasp-detail {
      display: none;
      padding: 0 20px 20px 20px;
      color: #495057;
      line-height: 1.6;
      border-top: 1px solid #dee2e6;
      margin: 0 20px;
      padding-top: 16px;
    }
    
    .owasp-item.active .owasp-detail {
      display: block;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; max-height: 0; }
      to { opacity: 1; max-height: 500px; }
    }
    
    /* Checkmark for explored items */
    .owasp-checkmark {
      color: var(--success-green);
      font-size: 18px;
      font-weight: bold;
      margin-left: 8px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    /* Interactive Code Review Styles */
    .code-line {
      position: relative;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #d4d4d4;
    }
    
    .code-line:hover {
      background: rgba(123,44,191,0.1);
      transform: translateX(4px);
    }
    
    .code-line.analyzed {
      background: rgba(255,255,255,0.05);
    }
    
    .code-line.critical {
      background: rgba(244,67,54,0.1);
      border-left: 3px solid #f44336;
    }
    
    .code-line.safe {
      background: rgba(76,175,80,0.1);
      border-left: 3px solid #4CAF50;
    }
    
    .line-indicator {
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes scanLine {
      from { background-position: -100% 0; }
      to { background-position: 200% 0; }
    }
    
    .scanning-line {
      background: linear-gradient(90deg, transparent, rgba(76,175,80,0.3), transparent);
      background-size: 50% 100%;
      animation: scanLine 1s linear;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .owasp-item[data-explored="true"] .owasp-checkmark {
      opacity: 1;
    }
    
    .owasp-item[data-explored="true"] .owasp-header {
      background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(76,175,80,0.05));
      border-radius: 8px;
    }
    
    /* Responsive */
    @media (max-width:768px) {
      .slide { padding:32px 24px; }
      h1 { font-size:2rem; }
      h2 { font-size:1.5rem; }
      .decision-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Achievement Popup -->
  <div class="achievement" id="achievementPopup">
    <div class="achievement-icon" id="achievementIcon">🏆</div>
    <div>
      <div style="font-weight:700; color:var(--dark-purple);" id="achievementTitle">Achievement Unlocked!</div>
      <div style="font-size:14px; color:#6c757d;" id="achievementText">You're making great progress!</div>
    </div>
  </div>

  <!-- Confetti Container -->
  <div class="confetti-container" id="confettiContainer"></div>

  <div class="module-container">
    <div class="grc-header">
      <div class="grc-logo">
        <div class="grc-owl" onclick="owlClick()">👾</div>
        <span>Secure Coding (OWASP)</span>
      </div>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>

    <!-- Slide 1: Welcome -->
    <div class="slide active" id="slide1">
      <h1>🔐 Secure Coding Training</h1>
      <div class="intro-animation">💻</div>
      <p style="text-align:center; font-size:1.4rem; margin-bottom:24px; color:#7B2CBF; font-weight:600;">
        Master OWASP Top 10 Security Best Practices
      </p>
      
      <div style="background:#f0f7ff; padding:24px; border-radius:12px; margin:20px auto; max-width:700px; border:1px solid #d0e4ff;">
        <p style="font-size:1.1rem; color:#333; margin-bottom:16px; font-weight:600;">
          In this training you will learn to:
        </p>
        <ul style="text-align:left; font-size:1rem; color:#555; line-height:1.8; max-width:500px; margin:0 auto; list-style:none;">
          <li>💉 <strong>Prevent SQL injection</strong> and other injection attacks</li>
          <li>🔍 <strong>Conduct secure code reviews</strong> to catch vulnerabilities</li>
          <li>📦 <strong>Manage dependencies</strong> and identify vulnerable packages</li>
          <li>🛡️ <strong>Implement authentication</strong> and authorization properly</li>
        </ul>
      </div>
      
      <div style="margin:32px auto; max-width:700px;">
        <p style="font-size:1.2rem; color:#333; margin-bottom:32px; text-align:center;">
          Please select your role to continue:
        </p>
        <div class="decision-grid" style="max-width:600px; margin:0 auto;">
          <button class="decision-btn" onclick="roleCheck('engineer')" style="padding:24px; font-size:1.1rem;">
            <span style="font-size:1.5rem; margin-bottom:8px; display:block;">👨‍💻</span>
            I'm an Engineer/Developer
          </button>
          <button class="decision-btn" onclick="roleCheck('other')" style="padding:24px; font-size:1.1rem;">
            <span style="font-size:1.5rem; margin-bottom:8px; display:block;">👔</span>
            Other Role
          </button>
        </div>
        <p style="font-size:0.9rem; color:#666; margin-top:24px; text-align:center; font-style:italic;">
          💡 This training contains technical secure coding content designed for developers
        </p>
      </div>
      
      <!-- Skip Confirmation Popup -->
      <div id="popupOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9998;"></div>
      <div id="skipConfirmation" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:32px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.2); z-index:9999; max-width:500px;">
        <h3 style="color:#ff9800; margin:0 0 16px 0;">⚠️ Training Recommendation</h3>
        <p style="color:#333; margin-bottom:24px;">This secure coding training contains technical content specifically designed for engineers and developers. As a non-technical role, you can:</p>
        <div style="display:flex; gap:16px; justify-content:center; align-items:center;">
          <button class="btn" onclick="document.getElementById('skipConfirmation').style.display='none'; document.getElementById('popupOverlay').style.display='none'; skipToCompletion();" style="background:linear-gradient(135deg, #4CAF50, #45a049); padding:12px 24px; min-width:150px;">
            ✅ Skip & Complete
          </button>
          <button class="btn btn-secondary" onclick="document.getElementById('skipConfirmation').style.display='none'; document.getElementById('popupOverlay').style.display='none'; startTraining();" style="padding:12px 24px; min-width:150px;">
            👀 Continue Anyway
          </button>
        </div>
        <p style="font-size:0.85rem; color:#666; margin-top:16px; text-align:center; font-style:italic;">
          Both options will mark your training as complete
        </p>
      </div>
      
      <div class="navigation">
        <span></span>
      </div>
    </div>

    <!-- Slide 2: OWASP Top 10 Interactive List -->
    <div class="slide" id="slide2">
      <h2>📚 OWASP Top 10 Security Risks</h2>
      <p>Click on each item to learn more about these critical security vulnerabilities:</p>
      
      <div style="max-width: 900px; margin: 32px auto;">
        <div class="owasp-item" onclick="toggleOWASP(this, 1)">
          <div class="owasp-header">
            <span class="owasp-number">1</span>
            <span class="owasp-icon">💉</span>
            <span class="owasp-title">Injection</span>
            <span class="owasp-checkmark">✓</span>
            <span class="owasp-arrow">▶</span>
          </div>
          <div class="owasp-detail">
            <p><strong>What it is:</strong> Injection occurs when malicious code is inserted into vulnerable programs through untrusted data inputs.</p>
            
            <p><strong>Real-world example:</strong> In 2017, Equifax was breached due to a SQL injection vulnerability, exposing 147 million records. The attack used a simple payload like <code>' UNION SELECT password FROM users--</code></p>
            
            <p><strong>Prevention:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Use parameterized queries: <code>SELECT * FROM users WHERE id = ?</code></li>
              <li>Validate all inputs server-side</li>
              <li>Use ORM frameworks with built-in protections</li>
              <li>Apply principle of least privilege to database accounts</li>
            </ul>
            
            <p style="margin-top: 12px;"><strong>📚 Resources:</strong> <a href="https://owasp.org/www-community/attacks/SQL_Injection" target="_blank" style="color: var(--primary-purple);">OWASP SQL Injection</a> | <a href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html" target="_blank" style="color: var(--primary-purple);">Prevention Cheat Sheet</a></p>
          </div>
        </div>
        
        <div class="owasp-item" onclick="toggleOWASP(this, 2)">
          <div class="owasp-header">
            <span class="owasp-number">2</span>
            <span class="owasp-icon">🔐</span>
            <span class="owasp-title">Broken Authentication</span>
            <span class="owasp-checkmark">✓</span>
            <span class="owasp-arrow">▶</span>
          </div>
          <div class="owasp-detail">
            <p><strong>What it is:</strong> Vulnerabilities in authentication and session management that allow attackers to compromise passwords, keys, or session tokens.</p>
            
            <p><strong>Real-world example:</strong> In 2019, Capital One was breached when an attacker used misconfigured AWS credentials to access 100 million customer records. The attack exploited weak authentication controls.</p>
            
            <p><strong>Prevention:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Implement multi-factor authentication (MFA) everywhere</li>
              <li>Use secure secret management systems (HashiCorp Vault, AWS Secrets)</li>
              <li>Rotate credentials regularly and automatically</li>
              <li>Enforce strong password policies (12+ chars, complexity)</li>
              <li>Implement session timeout and secure cookie flags</li>
            </ul>
            
            <p style="margin-top: 12px;"><strong>📚 Resources:</strong> <a href="https://owasp.org/www-project-top-ten/2017/A2_2017-Broken_Authentication" target="_blank" style="color: var(--primary-purple);">OWASP Broken Authentication</a> | <a href="https://owasp.org/www-community/secrets-management" target="_blank" style="color: var(--primary-purple);">Secrets Management</a></p>
          </div>
        </div>
        
        <div class="owasp-item" onclick="toggleOWASP(this, 3)">
          <div class="owasp-header">
            <span class="owasp-number">3</span>
            <span class="owasp-icon">🕵️</span>
            <span class="owasp-title">Sensitive Data Exposure</span>
            <span class="owasp-checkmark">✓</span>
            <span class="owasp-arrow">▶</span>
          </div>
          <div class="owasp-detail">
            <p><strong>What it is:</strong> Applications fail to protect sensitive data like credit cards, health records, and personal information through inadequate encryption or storage practices.</p>
            
            <p><strong>Real-world example:</strong> In 2018, Marriott exposed 500 million guest records stored in plain text for years. The data included passport numbers, names, and encrypted payment cards - but the encryption keys were also compromised!</p>
            
            <p><strong>Prevention:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Encrypt all data at rest (AES-256) and in transit (TLS 1.3)</li>
              <li>Use secure environment variable management (not plain text files)</li>
              <li>Classify data and apply appropriate protection levels</li>
              <li>Disable autocomplete on sensitive forms</li>
              <li>Use secure key management (AWS KMS, Azure Key Vault)</li>
            </ul>
            
            <p style="margin-top: 12px;"><strong>📚 Resources:</strong> <a href="https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure" target="_blank" style="color: var(--primary-purple);">OWASP Sensitive Data</a> | <a href="https://csrc.nist.gov/publications/detail/fips/140/2/final" target="_blank" style="color: var(--primary-purple);">NIST Encryption Standards</a></p>
          </div>
        </div>
        
        <div class="owasp-item" onclick="toggleOWASP(this, 4)">
          <div class="owasp-header">
            <span class="owasp-number">4</span>
            <span class="owasp-icon">🔗</span>
            <span class="owasp-title">XML External Entities (XXE)</span>
            <span class="owasp-checkmark">✓</span>
            <span class="owasp-arrow">▶</span>
          </div>
          <div class="owasp-detail">
            <p><strong>What it is:</strong> XML parsers evaluate external entity references within XML documents, leading to disclosure of internal files, internal port scanning, or remote code execution.</p>
            
            <p><strong>Real-world example:</strong> In 2014, Facebook's XML parser was exploited to read local files from their servers. Attackers used payloads like:</p>
            <code style="display: block; background: #f0f0f0; padding: 8px; margin: 8px 0; border-radius: 4px; font-size: 12px;">
&lt;?xml version="1.0"?&gt;<br>
&lt;!DOCTYPE data [&lt;!ENTITY xxe SYSTEM "file:///etc/passwd"&gt;]&gt;<br>
&lt;data&gt;&amp;xxe;&lt;/data&gt;
            </code>
            
            <p><strong>Prevention:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Disable external entities: <code>DocumentBuilderFactory.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true)</code></li>
              <li>Use JSON instead of XML when possible</li>
              <li>Validate and sanitize all XML inputs</li>
              <li>Use XML processors with secure defaults</li>
              <li>Implement whitelist input validation</li>
            </ul>
            
            <p style="margin-top: 12px;"><strong>📚 Resources:</strong> <a href="https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing" target="_blank" style="color: var(--primary-purple);">OWASP XXE Guide</a> | <a href="https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html" target="_blank" style="color: var(--primary-purple);">XXE Prevention</a></p>
          </div>
        </div>
        
        <div class="owasp-item" onclick="toggleOWASP(this, 5)">
          <div class="owasp-header">
            <span class="owasp-number">5</span>
            <span class="owasp-icon">🚪</span>
            <span class="owasp-title">Broken Access Control</span>
            <span class="owasp-checkmark">✓</span>
            <span class="owasp-arrow">▶</span>
          </div>
          <div class="owasp-detail">
            <p><strong>What it is:</strong> Users can access unauthorized functionality and data due to missing or ineffective access control checks.</p>
            
            <p><strong>Real-world example:</strong> In 2019, First American Financial Corp exposed 885 million documents by failing to implement proper access controls. Changing URL parameters gave access to any customer's mortgage documents: <code>/document/12345</code> → <code>/document/99999</code></p>
            
            <p><strong>Prevention:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Implement Role-Based Access Control (RBAC)</li>
              <li>Run applications with minimal required privileges</li>
              <li>Validate access controls on every request</li>
              <li>Apply principle of least privilege everywhere</li>
              <li>Implement network segmentation and access controls</li>
            </ul>
            
            <p style="margin-top: 12px;"><strong>📚 Resources:</strong> <a href="https://owasp.org/www-project-top-ten/2017/A5_2017-Broken_Access_Control" target="_blank" style="color: var(--primary-purple);">OWASP Access Control</a> | <a href="https://www.nist.gov/privacy-framework/nist-sp-800-53" target="_blank" style="color: var(--primary-purple);">NIST Security Controls</a></p>
          </div>
        </div>
        
        <div class="owasp-item" onclick="toggleOWASP(this, 6)">
          <div class="owasp-header">
            <span class="owasp-number">6</span>
            <span class="owasp-icon">⚙️</span>
            <span class="owasp-title">Security Misconfiguration</span>
            <span class="owasp-checkmark">✓</span>
            <span class="owasp-arrow">▶</span>
          </div>
          <div class="owasp-detail">
            <p><strong>What it is:</strong> Applications, frameworks, and servers are often misconfigured, leaving systems vulnerable through insecure default configurations, incomplete setups, or outdated software.</p>
            
            <p><strong>Real-world example:</strong> In 2017, a misconfigured AWS S3 bucket exposed 198 million voter records from Deep Root Analytics. The bucket was set to public read access when it should have been private.</p>
            
            <p><strong>Common misconfigurations:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Default usernames/passwords still active</li>
              <li>Unnecessary features or services enabled</li>
              <li>Missing security headers</li>
              <li>Verbose error messages revealing system information</li>
              <li>Outdated or unpatched software components</li>
            </ul>
            
            <p><strong>Prevention:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Implement secure defaults and hardening guides</li>
              <li>Remove unnecessary features, components, and documentation</li>
              <li>Keep all systems updated with latest security patches</li>
              <li>Use automated security configuration scanning</li>
              <li>Implement proper error handling (don't leak system info)</li>
            </ul>
            
            <p style="margin-top: 12px;"><strong>📚 Resources:</strong> <a href="https://owasp.org/www-project-top-ten/2017/A6_2017-Security_Misconfiguration" target="_blank" style="color: var(--primary-purple);">OWASP Security Misconfiguration</a> | <a href="https://cisecurity.org/cis-benchmarks/" target="_blank" style="color: var(--primary-purple);">CIS Security Benchmarks</a></p>
          </div>
        </div>
        
        <div class="owasp-item" onclick="toggleOWASP(this, 7)">
          <div class="owasp-header">
            <span class="owasp-number">7</span>
            <span class="owasp-icon">💻</span>
            <span class="owasp-title">Cross-Site Scripting (XSS)</span>
            <span class="owasp-checkmark">✓</span>
            <span class="owasp-arrow">▶</span>
          </div>
          <div class="owasp-detail">
            <p><strong>What it is:</strong> Malicious scripts are injected into trusted websites, executing in users' browsers to steal cookies, session tokens, or redirect users to malicious sites.</p>
            
            <p><strong>Real-world example:</strong> In 2018, British Airways suffered an XSS attack where malicious JavaScript was injected into their payment page, stealing 380,000 customers' payment card details. The script looked like:</p>
            <code style="display: block; background: #f0f0f0; padding: 8px; margin: 8px 0; border-radius: 4px; font-size: 12px;">
&lt;script&gt;document.getElementById('card').value = steal();&lt;/script&gt;
            </code>
            
            <p><strong>Common XSS scenarios:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>User input displayed without validation: <code>&lt;p&gt;Hello {{username}}&lt;/p&gt;</code></li>
              <li>URL parameters reflected in pages</li>
              <li>Unsafe innerHTML usage in JavaScript</li>
              <li>User-generated content in comments or profiles</li>
            </ul>
            
            <p><strong>Prevention:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Use context-aware escaping: HTML escape for HTML, JS escape for JavaScript</li>
              <li>Enable Content Security Policy: <code>Content-Security-Policy: default-src 'self'</code></li>
              <li>Use safe APIs: <code>textContent</code> instead of <code>innerHTML</code></li>
              <li>Validate all input server-side with whitelist approach</li>
              <li>Use frameworks with built-in XSS protection (React, Angular)</li>
            </ul>
            
            <p style="margin-top: 12px;"><strong>📚 Resources:</strong> <a href="https://owasp.org/www-community/attacks/xss/" target="_blank" style="color: var(--primary-purple);">OWASP XSS Guide</a> | <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html" target="_blank" style="color: var(--primary-purple);">XSS Prevention</a></p>
          </div>
        </div>
        
        <div class="owasp-item" onclick="toggleOWASP(this, 8)">
          <div class="owasp-header">
            <span class="owasp-number">8</span>
            <span class="owasp-icon">📦</span>
            <span class="owasp-title">Insecure Deserialization</span>
            <span class="owasp-checkmark">✓</span>
            <span class="owasp-arrow">▶</span>
          </div>
          <div class="owasp-detail">
            <p><strong>What it is:</strong> Applications deserialize untrusted data without proper validation, potentially leading to remote code execution, replay attacks, or privilege escalation.</p>
            
            <p><strong>Real-world example:</strong> In 2017, Apache Struts was exploited via insecure deserialization, affecting companies like Equifax. Attackers sent malicious serialized objects that executed system commands when deserialized.</p>
            
            <p><strong>Dangerous scenarios:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Accepting pickled objects in Python applications</li>
              <li>Java applications deserializing untrusted ObjectInputStream data</li>
              <li>PHP applications using unserialize() on user input</li>
              <li>Node.js apps using eval() on serialized JSON</li>
            </ul>
            
            <p><strong>Prevention:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Never deserialize data from untrusted sources</li>
              <li>Use signing/encryption for serialized data: HMAC, JWT</li>
              <li>Implement strict type constraints during deserialization</li>
              <li>Use safe serialization formats like JSON (no code execution)</li>
              <li>Monitor deserialization exceptions and failures</li>
              <li>Run deserialization code in low-privilege environments</li>
            </ul>
            
            <p style="margin-top: 12px;"><strong>📚 Resources:</strong> <a href="https://owasp.org/www-project-top-ten/2017/A8_2017-Insecure_Deserialization" target="_blank" style="color: var(--primary-purple);">OWASP Deserialization</a> | <a href="https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html" target="_blank" style="color: var(--primary-purple);">Deserialization Prevention</a></p>
          </div>
        </div>
        
        <div class="owasp-item" onclick="toggleOWASP(this, 9)">
          <div class="owasp-header">
            <span class="owasp-number">9</span>
            <span class="owasp-icon">🔧</span>
            <span class="owasp-title">Using Components with Known Vulnerabilities</span>
            <span class="owasp-checkmark">✓</span>
            <span class="owasp-arrow">▶</span>
          </div>
          <div class="owasp-detail">
            <p><strong>What it is:</strong> Applications use components (libraries, frameworks, modules) with known security vulnerabilities, providing attackers easy entry points.</p>
            
            <p><strong>Real-world example:</strong> In 2017, the WannaCry ransomware exploited a Windows SMB vulnerability (CVE-2017-0144) that had been patched months earlier. Organizations running unpatched systems were crippled worldwide.</p>
            
            <p><strong>Critical vulnerability examples:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li><strong>Log4j (2021):</strong> Remote code execution in logging library used by millions</li>
              <li><strong>Struts (2017):</strong> Led to Equifax breach affecting 147M people</li>
              <li><strong>OpenSSL Heartbleed (2014):</strong> Memory disclosure in encryption library</li>
              <li><strong>jQuery XSS (2019):</strong> Cross-site scripting in popular JavaScript library</li>
            </ul>
            
            <p><strong>Prevention:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Maintain inventory of all components and versions</li>
              <li>Monitor CVE databases: <code>npm audit</code>, <code>pip-audit</code>, Snyk, WhiteSource</li>
              <li>Update components regularly with automated dependency updates</li>
              <li>Remove unused dependencies and features</li>
              <li>Use Software Composition Analysis (SCA) tools</li>
              <li>Subscribe to security mailing lists for your technology stack</li>
            </ul>
            
            <p style="margin-top: 12px;"><strong>📚 Resources:</strong> <a href="https://owasp.org/www-project-top-ten/2017/A9_2017-Using_Components_with_Known_Vulnerabilities" target="_blank" style="color: var(--primary-purple);">OWASP Vulnerable Components</a> | <a href="https://cve.mitre.org/" target="_blank" style="color: var(--primary-purple);">CVE Database</a></p>
          </div>
        </div>
        
        <div class="owasp-item" onclick="toggleOWASP(this, 10)">
          <div class="owasp-header">
            <span class="owasp-number">10</span>
            <span class="owasp-icon">📊</span>
            <span class="owasp-title">Insufficient Logging & Monitoring</span>
            <span class="owasp-checkmark">✓</span>
            <span class="owasp-arrow">▶</span>
          </div>
          <div class="owasp-detail">
            <p><strong>What it is:</strong> Lack of proper logging and monitoring allows breaches to go undetected for months, giving attackers time to achieve their goals and cover their tracks.</p>
            
            <p><strong>Real-world example:</strong> The Target breach (2013) went undetected for 19 days despite security tools alerting on the intrusion. Poor monitoring meant 40 million credit cards were stolen before discovery. Average breach detection time is still 277 days (IBM, 2022).</p>
            
            <p><strong>Critical events to log:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Failed login attempts and account lockouts</li>
              <li>Privilege escalation and administrative actions</li>
              <li>Input validation failures and injection attempts</li>
              <li>Authentication token manipulation</li>
              <li>Server-side request forgery (SSRF) attempts</li>
            </ul>
            
            <p><strong>Prevention & Detection:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Log all security-relevant events with sufficient context</li>
              <li>Use centralized logging: ELK Stack, Splunk, CloudWatch</li>
              <li>Implement real-time alerting for suspicious patterns</li>
              <li>Ensure log integrity (tamper-proof, off-site storage)</li>
              <li>Regularly test incident response procedures</li>
              <li>Use Security Information and Event Management (SIEM) tools</li>
            </ul>
            
            <p style="margin-top: 12px;"><strong>📚 Resources:</strong> <a href="https://owasp.org/www-project-top-ten/2017/A10_2017-Insufficient_Logging%2526Monitoring" target="_blank" style="color: var(--primary-purple);">OWASP Logging & Monitoring</a> | <a href="https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html" target="_blank" style="color: var(--primary-purple);">Logging Best Practices</a></p>
          </div>
        </div>
      </div>
      
      <div style="text-align: center; margin: 24px 0;">
        <p style="font-size: 18px; color: var(--primary-purple); font-weight: 600;">
          <span id="owaspCount">0</span>/10 explored
        </p>
      </div>
      
      <div class="navigation">
        <button class="btn btn-secondary" onclick="previousSlide()">← Back</button>
        <button class="btn" onclick="nextSlide()" id="owaspContinue" style="display:none;">Continue →</button>
      </div>
    </div>

    <!-- Slide 3: SQL Injection Detection Simulation -->
    <div class="slide" id="slide3">
      <h2>🚨 Interactive SQL Injection Lab</h2>
      <p>You're reviewing a colleague's pull request. First identify the vulnerability, then see it in action!</p>
      
      <div class="simulation-box">
        <div style="background: #1e1e1e; border-radius: 12px; padding: 20px; font-family: 'Monaco', 'Courier New', monospace;">
          <div style="background: #2d2d2d; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
            <div style="color: #569cd6; font-weight: bold; margin-bottom: 10px;">// User authentication endpoint</div>
            <div style="color: #dcdcaa;">async function authenticateUser(email, password) {</div>
            <div style="color: #d4d4d4; margin-left: 20px;">
              <div id="vulnerable-line" style="position: relative;">const query = <span style="color: #ce9178;">"SELECT * FROM users WHERE email = '"</span> + <span id="email-param" style="background: rgba(255,0,0,0.2); padding: 2px 4px; border-radius: 3px;">email</span> + <span style="color: #ce9178;">"' AND password = '"</span> + <span id="password-param" style="background: rgba(255,0,0,0.2); padding: 2px 4px; border-radius: 3px;">password</span> + <span style="color: #ce9178;">"'"</span>;
                <span id="vulnerability-arrow" style="display: none; color: #ff3b30; font-size: 20px; margin-left: 10px;">← 🚨 VULNERABLE!</span>
              </div>
              <div style="margin-top: 10px;">const result = await db.query(<span id="query-param" style="background: rgba(255,255,0,0.2); padding: 2px 4px; border-radius: 3px;">query</span>);</div>
              <div>return result.rows[0];</div>
            </div>
            <div style="color: #dcdcaa;">}</div>
          </div>
          
          <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px;">
            <p style="margin: 0; color: #856404; font-weight: 600;">⚠️ Security Review Required</p>
            <p style="margin: 10px 0 0 0; color: #333;">This code handles user authentication for a web application. What's the critical vulnerability?</p>
          </div>
        </div>
        
        <p style="text-align:center; font-weight:600; margin-top:24px;">What's the vulnerability in this code?</p>
      </div>
      
      <div class="decision-grid">
        <button class="decision-btn" onclick="ransomwareDecision('validation')" id="ransom-validation">Missing input validation</button>
        <button class="decision-btn" onclick="ransomwareDecision('concatenation')" id="ransom-concatenation">String concatenation creates SQL injection</button>
        <button class="decision-btn" onclick="ransomwareDecision('async')" id="ransom-async">Using async/await is insecure</button>
        <button class="decision-btn" onclick="ransomwareDecision('password')" id="ransom-password">Storing plain text passwords</button>
      </div>
      
      <div id="ransomwareFeedback" style="margin-top:24px;"></div>
      
      <!-- Interactive SQL Injection Demo (shows after correct answer) -->
      <div id="sqlDemo" style="display: none; margin-top: 32px; background: #f8f9fa; border-radius: 12px; padding: 24px; border: 2px solid var(--primary-purple);">
        <h3 style="color: var(--dark-purple); margin-bottom: 16px;">🧪 Try the Attack!</h3>
        <p style="margin-bottom: 16px;">See how an attacker could exploit this vulnerability:</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div>
            <label style="font-weight: 600; margin-bottom: 8px; display: block;">Email Input:</label>
            <input type="text" id="emailTest" placeholder="user@example.com" 
                   style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-family: monospace;"
                   onkeyup="updateQuery()">
          </div>
          <div>
            <label style="font-weight: 600; margin-bottom: 8px; display: block;">Password Input:</label>
            <input type="text" id="passwordTest" placeholder="password123" 
                   style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-family: monospace;"
                   onkeyup="updateQuery()">
          </div>
        </div>
        
        <div style="margin-bottom: 16px;">
          <h4 style="color: var(--dark-purple); margin-bottom: 8px;">Generated SQL Query:</h4>
          <div id="generatedQuery" style="background: #2d2d2d; color: #d4d4d4; padding: 16px; border-radius: 8px; font-family: monospace; word-break: break-all;">
            SELECT * FROM users WHERE email = 'user@example.com' AND password = 'password123'
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
          <button class="btn btn-secondary" onclick="loadSample('normal')" style="font-size: 14px;">Normal Login</button>
          <button class="btn" onclick="loadSample('bypass')" style="background: linear-gradient(135deg, #ff9800, #f57c00); font-size: 14px;">SQL Injection Attack</button>
          <button class="btn" onclick="loadSample('union')" style="background: linear-gradient(135deg, #f44336, #d32f2f); font-size: 14px;">Advanced: UNION Attack</button>
        </div>
        
        <div id="queryResult" style="min-height: 80px; background: #fff; border: 2px solid #e0e0e0; border-radius: 8px; padding: 16px;">
          <div style="background: #f5f5f5; border-left: 4px solid #2196F3; padding: 12px;">
            <strong style="color: #1976D2;">👆 Try the attack buttons above to see what happens!</strong><br>
            <span style="color: #666;">Or type your own values to test SQL injection patterns like: ' OR '1'='1</span>
          </div>
        </div>
      </div>
      
      <div class="navigation">
        <button class="btn btn-secondary" onclick="previousSlide()">← Back</button>
        <button class="btn" onclick="nextSlide()" id="ransomwareContinue" style="display:none;">Continue →</button>
      </div>
    </div>

    <!-- Slide 4: Code Review Simulation -->
    <div class="slide" id="slide4">
      <h2>🔍 Interactive Security Code Review</h2>
      <p>Analyze this authentication function. Click on code lines to investigate, then run the security scanner!</p>
      
      <!-- Mode Selector -->
      <div style="display: flex; gap: 12px; justify-content: center; margin-bottom: 20px;">
        <button class="btn btn-secondary" onclick="setReviewMode('analyze')" id="analyzeMode" style="background: var(--primary-purple); color: white;">
          🔍 Analyze Mode
        </button>
        <button class="btn btn-secondary" onclick="setReviewMode('scan')" id="scanMode">
          🛡️ Security Scan
        </button>
        <button class="btn btn-secondary" onclick="setReviewMode('fix')" id="fixMode" disabled>
          🔧 Fix Issues
        </button>
      </div>
      
      <div class="website-simulator">
        <div class="browser-bar">
          <div class="browser-controls">
            <div class="browser-dot"></div>
            <div class="browser-dot"></div>
            <div class="browser-dot"></div>
          </div>
          <div class="url-bar">
            <span id="codeReviewStatus">Code Review Tool - Analyzing...</span>
          </div>
        </div>
        <div class="website-content" style="background: #1e1e1e; padding: 20px; position: relative;">
          <!-- Line-by-line interactive code -->
          <div style="font-family: 'Monaco', monospace; font-size: 14px;">
            <div class="code-line" onclick="analyzeCodeLine(0)" data-line="0" style="position: relative; padding: 4px 8px; border-radius: 4px; cursor: pointer; transition: all 0.3s;">
              <span style="color: #c586c0;">const</span> JWT_SECRET = <span style="color: #ce9178;">"secret2024Key!"</span>;
              <span class="line-comment" style="color: #6a9955;"> // Line 1</span>
              <span class="line-indicator" style="position: absolute; right: 10px; top: 4px; display: none;">🔍</span>
              <div class="line-analysis" id="analysis-0" style="display: none; background: rgba(244,67,54,0.1); border-left: 3px solid #f44336; padding: 8px; margin-top: 4px; font-size: 12px; color: #ff9999;">
                🔴 CRITICAL: Hard-coded secret key in source code!
              </div>
            </div>
            
            <div style="padding: 4px 8px; color: #d4d4d4;"> </div>
            
            <div class="code-line" onclick="analyzeCodeLine(1)" data-line="1" style="position: relative; padding: 4px 8px; border-radius: 4px; cursor: pointer; transition: all 0.3s;">
              <span style="color: #569cd6;">function</span> <span style="color: #dcdcaa;">validateLogin</span>(email, password, hashedPassword) {
              <span class="line-indicator" style="position: absolute; right: 10px; top: 4px; display: none;">🔍</span>
            </div>
            
            <div class="code-line" onclick="analyzeCodeLine(2)" data-line="2" style="position: relative; padding: 4px 8px; margin-left: 20px; border-radius: 4px; cursor: pointer; transition: all 0.3s;">
              <span style="color: #9cdcfe;">console</span>.<span style="color: #dcdcaa;">log</span>(<span style="color: #ce9178;">`Login attempt for ${email} with password: ${password}`</span>);
              <span class="line-comment" style="color: #6a9955;"> // Line 2</span>
              <span class="line-indicator" style="position: absolute; right: 10px; top: 4px; display: none;">🔍</span>
              <div class="line-analysis" id="analysis-2" style="display: none; background: rgba(244,67,54,0.1); border-left: 3px solid #f44336; padding: 8px; margin-top: 4px; font-size: 12px; color: #ff9999;">
                🔴 CRITICAL: Logging sensitive data (passwords and email/PII) in plain text!
              </div>
            </div>
            
            <div style="padding: 4px 8px; margin-left: 20px; color: #d4d4d4;"> </div>
            
            <div class="code-line" onclick="analyzeCodeLine(3)" data-line="3" style="position: relative; padding: 4px 8px; margin-left: 20px; border-radius: 4px; cursor: pointer; transition: all 0.3s;">
              <span style="color: #c586c0;">const</span> isValid = <span style="color: #9cdcfe;">bcrypt</span>.<span style="color: #dcdcaa;">compareSync</span>(password, hashedPassword);
              <span class="line-comment" style="color: #6a9955;"> // Line 3</span>
              <span class="line-indicator" style="position: absolute; right: 10px; top: 4px; display: none;">🔍</span>
              <div class="line-analysis" id="analysis-3" style="display: none; background: rgba(76,175,80,0.1); border-left: 3px solid #4CAF50; padding: 8px; margin-top: 4px; font-size: 12px; color: #81c784;">
                ✅ GOOD: Using bcrypt for secure password comparison
              </div>
            </div>
            
            <div style="padding: 4px 8px; margin-left: 20px; color: #d4d4d4;"> </div>
            
            <div class="code-line" onclick="analyzeCodeLine(4)" data-line="4" style="position: relative; padding: 4px 8px; margin-left: 20px; border-radius: 4px; cursor: pointer; transition: all 0.3s;">
              <span style="color: #c586c0;">const</span> token = <span style="color: #9cdcfe;">jwt</span>.<span style="color: #dcdcaa;">sign</span>({email}, JWT_SECRET);
              <span class="line-comment" style="color: #6a9955;"> // Line 4 - Uses the hardcoded secret!</span>
              <span class="line-indicator" style="position: absolute; right: 10px; top: 4px; display: none;">🔍</span>
              <div class="line-analysis" id="analysis-4" style="display: none; background: rgba(255,152,0,0.1); border-left: 3px solid #ff9800; padding: 8px; margin-top: 4px; font-size: 12px; color: #ffb74d;">
                ⚠️ WARNING: Using hardcoded JWT_SECRET from line 1
              </div>
            </div>
            
            <div style="padding: 4px 8px; margin-left: 20px; color: #d4d4d4;"> </div>
            
            <div class="code-line" onclick="analyzeCodeLine(5)" data-line="5" style="position: relative; padding: 4px 8px; margin-left: 20px; border-radius: 4px; cursor: pointer; transition: all 0.3s;">
              <span style="color: #c586c0;">return</span> {isValid, token};
              <span class="line-comment" style="color: #6a9955;"> // Line 5</span>
              <span class="line-indicator" style="position: absolute; right: 10px; top: 4px; display: none;">🔍</span>
              <div class="line-analysis" id="analysis-5" style="display: none; background: rgba(76,175,80,0.1); border-left: 3px solid #4CAF50; padding: 8px; margin-top: 4px; font-size: 12px; color: #81c784;">
                ✅ OK: Standard return statement
              </div>
            </div>
            
            <div class="code-line" data-line="6" style="padding: 4px 8px;">
              <span style="color: #d4d4d4;">}</span>
            </div>
          </div>
          
          <!-- Security Scanner Overlay -->
          <div id="scannerOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10; border-radius: 8px;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
              <div style="color: #4CAF50; font-size: 48px; animation: spin 2s linear infinite;">🔍</div>
              <div style="color: white; margin-top: 16px; font-size: 18px;">Scanning for vulnerabilities...</div>
              <div style="width: 200px; height: 4px; background: #333; border-radius: 2px; margin: 16px auto;">
                <div id="scanProgress" style="width: 0%; height: 100%; background: #4CAF50; border-radius: 2px; transition: width 0.3s;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Vulnerability Report (shows after scan) -->
      <div id="vulnerabilityReport" style="display: none; margin-top: 24px; background: #f8f9fa; border-radius: 12px; padding: 20px; border: 2px solid var(--primary-purple);">
        <h3 style="color: var(--dark-purple); margin-bottom: 16px;">🛡️ Security Scan Results</h3>
        <div id="reportContent"></div>
      </div>
      
      <!-- Fix Mode Panel (shows after issues identified) -->
      <div id="fixPanel" style="display: none; margin-top: 24px; background: #e8f5e9; border-radius: 12px; padding: 20px; border: 2px solid #4CAF50;">
        <h3 style="color: #2e7d32; margin-bottom: 16px;">🔧 Fix Security Issues</h3>
        <div id="fixContent"></div>
      </div>
      
      <div id="lockFeedback" style="margin-top:24px;"></div>
      
      <div class="navigation">
        <button class="btn btn-secondary" onclick="previousSlide()">← Back</button>
        <button class="btn" onclick="nextSlide()" id="lockContinue" style="display:none;">Continue →</button>
      </div>
    </div>

    <!-- Slide 5: Dependency Vulnerability Scanner -->
    <div class="slide" id="slide5">
      <h2>📦 Dependency Vulnerability Scanner</h2>
      <p>Your CI/CD pipeline detected critical vulnerabilities in npm packages. What's your action?</p>
      
      <div class="simulation-box">
        <div style="background: #1a1a1a; border-radius: 12px; padding: 20px;">
          <div style="background: #2d2d2d; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
            <h3 style="color: #ff3b30; margin: 0 0 15px 0;">🚨 Critical Vulnerabilities Detected</h3>
            <div style="font-family: 'Monaco', monospace; font-size: 14px; color: #d4d4d4; line-height: 1.8;">
              <div style="background: rgba(255,59,48,0.1); border-left: 4px solid #ff3b30; padding: 10px; margin-bottom: 10px;">
                <div style="color: #ff3b30; font-weight: bold;">• Package: jodit@3.14.2</div>
                <div style="color: #ff9500;">  CVE-2023-26469 - Remote Code Execution (CVSS: 9.8)</div>
                <div style="color: #d4d4d4;">  Attacker can execute arbitrary code via XSS in editor</div>
              </div>
              <div style="background: rgba(255,59,48,0.1); border-left: 4px solid #ff3b30; padding: 10px; margin-bottom: 10px;">
                <div style="color: #ff3b30; font-weight: bold;">• Package: xml2js@0.4.19</div>
                <div style="color: #ff9500;">  CVE-2023-0842 - XXE Injection (CVSS: 9.1)</div>
                <div style="color: #d4d4d4;">  XML External Entity attack allows file disclosure</div>
              </div>
              <div style="background: rgba(255,204,0,0.1); border-left: 4px solid #ffcc00; padding: 10px;">
                <div style="color: #ffcc00; font-weight: bold;">• Package: lodash@4.17.11</div>
                <div style="color: #ffcc00;">  CVE-2021-23337 - Command Injection (CVSS: 7.2)</div>
                <div style="color: #d4d4d4;">  template function allows command injection</div>
              </div>
            </div>
          </div>
          
          <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px;">
            <p style="margin: 0; color: #856404; font-weight: 600;">⚠️ Build Pipeline Decision Required</p>
            <p style="margin: 10px 0 0 0; color: #333;">Production deployment is scheduled in 2 hours. What's your action?</p>
          </div>
        </div>
      </div>
      
      <div class="decision-grid">
        <button class="decision-btn" onclick="dependencyDecision('ignore')" id="dep-ignore">Ignore - they're in dev dependencies</button>
        <button class="decision-btn" onclick="dependencyDecision('later')" id="dep-later">Schedule updates for next sprint</button>
        <button class="decision-btn" onclick="dependencyDecision('update')" id="dep-update">Update immediately and test</button>
        <button class="decision-btn" onclick="dependencyDecision('research')" id="dep-research">Research if we're affected first</button>
      </div>
      
      <div id="passwordCompleteFeedback" style="margin-top:24px;"></div>
      
      <div class="navigation">
        <button class="btn btn-secondary" onclick="previousSlide()">← Back</button>
        <button class="btn" onclick="nextSlide()" id="passwordContinue" style="display:none;">Continue →</button>
      </div>
    </div>

    <!-- Slide 6: Certificate -->
    <div class="slide" id="slide6">
      <div class="certificate">
        <div class="trophy-icon">🏆</div>
        <h1 style="color:var(--primary-purple); margin:24px 0;">Secure Coding Champion!</h1>
        <p style="font-size:1.25rem; color:var(--dark-purple); margin-bottom:32px;">
          You've mastered OWASP Top 10 secure coding practices!
        </p>
        
        <div style="margin:32px 0;">
          <div>
            <div style="font-size:2rem; font-weight:700; color:var(--primary-purple);" id="finalScore">100%</div>
            <div style="color:#6c757d;">Final Score</div>
          </div>
        </div>
        
        <p style="color:var(--primary-purple); font-weight:600; font-size:1.125rem;">
          Stay Vigilant. Stay Secure. 👾
        </p>
        
        <button class="btn" onclick="completeModule()" style="margin-top:24px;">Exit Training</button>
      </div>
    </div>
  </div>

  <div class="scorm-status" id="scormStatus">SCORM: Disconnected</div>

  <script>
    // SCORM API wrapper
    var scorm = {
      version: null, api: null,
      init: function() {
        try {
          this.api = this.getAPI();
          if (this.api) {
            this.version = this.getVersion();
            var result = this.api.LMSInitialize ? this.api.LMSInitialize("") : this.api.Initialize("");
            if (result == "true") {
              this.setStatus("initialized");
              this.setValue("cmi.core.lesson_status", "incomplete");
              this.setValue("cmi.core.score.min", "0");
              this.setValue("cmi.core.score.max", "100");
              this.setValue("cmi.core.score.raw", "0");
              this.commit();
              return true;
            }
          }
        } catch(e) { console.log("SCORM API not available - standalone mode"); }
        return false;
      },
      getAPI: function() {
        var api=null; if (window.parent && window.parent!=window) api=this.findAPI(window.parent);
        if (!api && window.opener) api=this.findAPI(window.opener);
        if (!api) api=this.findAPI(window);
        return api;
      },
      findAPI: function(win) {
        var i=0; while(!win.API && !win.API_1484_11 && win.parent && win.parent!=win && i<500){ i++; win=win.parent; }
        return win.API || win.API_1484_11;
      },
      getVersion: function(){ if(this.api){ if(this.api.LMSInitialize) return "1.2"; if(this.api.Initialize) return "2004";} return null; },
      getValue: function(e){ if(!this.api) return ""; return this.version=="1.2"? this.api.LMSGetValue(e): this.api.GetValue(e); },
      setValue: function(e,v){ if(!this.api) return false; return this.version=="1.2"? this.api.LMSSetValue(e,v): this.api.SetValue(e,v); },
      commit: function(){ if(!this.api) return false; return this.version=="1.2"? this.api.LMSCommit(""): this.api.Commit(""); },
      finish: function(){ if(!this.api) return false; return this.version=="1.2"? this.api.LMSFinish(""): this.api.Terminate(""); },
      setStatus: function(status){ var el=document.getElementById('scormStatus'); if(el){ el.textContent='SCORM: '+status; el.style.display='block'; } }
    };
    
    // Game state management
    let gameState = {
      currentSlide: 1,
      totalSlides: 6,
      userScore: 0,
      achievements: [],
      ransomwareComplete: false,
      lockComplete: false,
      passwordComplete: false,
      softwareComplete: false,
      scenariosCompleted: 0,
      totalScenarios: 4,
      choices: {},
      moduleCompleted: false
    };
    
    
    // Achievement system
    function showAchievement(icon, title, text) {
      const popup = document.getElementById('achievementPopup');
      document.getElementById('achievementIcon').textContent = icon;
      document.getElementById('achievementTitle').textContent = title;
      document.getElementById('achievementText').textContent = text;
      
      popup.classList.add('show');
      setTimeout(() => {
        popup.classList.remove('show');
      }, 3000);
    }
    
    // OWASP Top 10 Interactive Toggle Function
    function toggleOWASP(element, index) {
      const isActive = element.classList.contains('active');
      
      // Mark item as explored (add a data attribute)
      if (!element.hasAttribute('data-explored')) {
        element.setAttribute('data-explored', 'true');
      }
      
      // Track which OWASP items have been explored and which is active
      if (!gameState.owaspExplored) gameState.owaspExplored = [];
      if (!gameState.owaspExplored.includes(index)) {
        gameState.owaspExplored.push(index);
      }
      
      // Close all other OWASP items
      document.querySelectorAll('.owasp-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Toggle this item
      if (!isActive) {
        element.classList.add('active');
        gameState.owaspActive = index;
      } else {
        gameState.owaspActive = null;
      }
      
      // Save OWASP state using the same pattern as other decisions
      gameState.choices['owasp_explored'] = gameState.owaspExplored;
      gameState.choices['owasp_active'] = gameState.owaspActive;
      saveChoice('owasp_explored', gameState.owaspExplored);
      saveChoice('owasp_active', gameState.owaspActive);
      
      // Update counter based on explored items
      const exploredItems = document.querySelectorAll('.owasp-item[data-explored="true"]').length;
      document.getElementById('owaspCount').textContent = exploredItems;
      
      // Show continue button when at least one item has been explored
      if (exploredItems >= 1) {
        document.getElementById('owaspContinue').style.display = 'inline-flex';
      }
    }
    
    // Interactive SQL Demo Functions
    function updateQuery() {
      const email = document.getElementById('emailTest').value || 'user@example.com';
      const password = document.getElementById('passwordTest').value || 'password123';
      
      const query = `SELECT * FROM users WHERE email = '${email}' AND password = '${password}'`;
      document.getElementById('generatedQuery').textContent = query;
      
      // Analyze the query for potential issues
      analyzeQuery(email, password, query);
    }
    
    function analyzeQuery(email, password, query) {
      const resultDiv = document.getElementById('queryResult');
      let analysis = '';
      
      // Check for SQL injection patterns
      if (email.includes("'") || password.includes("'")) {
        if (email.includes("' OR '") || password.includes("' OR '") || 
            email.toLowerCase().includes("' or 1=1") || password.toLowerCase().includes("' or 1=1")) {
          analysis = `<div style="background: #ffebee; border-left: 4px solid #f44336; padding: 16px;">
            <strong style="color: #c62828;">🚨 SQL INJECTION DETECTED!</strong><br>
            <strong>Attack Type:</strong> Authentication Bypass<br>
            <strong>What happens:</strong> The OR condition makes the WHERE clause always TRUE<br>
            <strong>Database returns:</strong> ALL user records instead of checking credentials<br>
            <strong>Result:</strong> Attacker logs in without knowing any passwords!<br>
            <div style="background: #1e1e1e; color: #ff9999; padding: 8px; margin-top: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
              Query becomes: WHERE email = '' OR '1'='1' AND password = '...'<br>
              This evaluates to: WHERE (false) OR (true) = TRUE for every row!
            </div>
          </div>`;
        } else if (email.toUpperCase().includes("UNION") || password.toUpperCase().includes("UNION")) {
          analysis = `<div style="background: #ffebee; border-left: 4px solid #f44336; padding: 16px;">
            <strong style="color: #c62828;">💀 ADVANCED SQL INJECTION!</strong><br>
            <strong>Attack Type:</strong> UNION-based data extraction<br>
            <strong>What happens:</strong> Combines your query with attacker's query<br>
            <strong>Database returns:</strong> Data from OTHER tables (passwords, credit cards, etc.)<br>
            <strong>Result:</strong> Complete data breach - sensitive information exposed!<br>
            <div style="background: #1e1e1e; color: #ff9999; padding: 8px; margin-top: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
              Attacker can see: admin_passwords, payment_info, personal_data<br>
              All because of string concatenation vulnerability!
            </div>
          </div>`;
        } else if (email.includes("--") || password.includes("--") || 
                   email.includes("#") || password.includes("#")) {
          analysis = `<div style="background: #ffebee; border-left: 4px solid #f44336; padding: 16px;">
            <strong style="color: #c62828;">⚠️ SQL COMMENT INJECTION!</strong><br>
            <strong>Attack Type:</strong> Comment-based bypass<br>
            <strong>What happens:</strong> The -- or # comments out the rest of the query<br>
            <strong>Database ignores:</strong> Password check and other security conditions<br>
            <strong>Result:</strong> Authentication bypassed by ignoring password verification!
          </div>`;
        } else if (email.includes("DROP") || password.includes("DROP") || 
                   email.includes("DELETE") || password.includes("DELETE")) {
          analysis = `<div style="background: #ffebee; border-left: 4px solid #f44336; padding: 16px;">
            <strong style="color: #c62828;">☠️ DESTRUCTIVE SQL INJECTION!</strong><br>
            <strong>Attack Type:</strong> Data destruction attempt<br>
            <strong>What happens:</strong> Attacker tries to delete or drop database tables<br>
            <strong>Potential damage:</strong> Complete data loss, service outage<br>
            <strong>Real-world impact:</strong> Company could lose all customer data!
          </div>`;
        } else {
          analysis = `<div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 16px;">
            <strong style="color: #f57c00;">⚠️ Potential SQL Injection Risk</strong><br>
            <strong>Issue:</strong> The quote character (') could break the SQL syntax<br>
            <strong>Risk:</strong> If not properly escaped, this could be exploited<br>
            <strong>Fix needed:</strong> Use parameterized queries to safely handle special characters
          </div>`;
        }
      } else if (email === '' && password === '') {
        analysis = `<div style="background: #f5f5f5; border-left: 4px solid #9e9e9e; padding: 16px;">
          <em style="color: #666;">Enter values above or click the attack buttons to see what happens...</em>
        </div>`;
      } else {
        analysis = `<div style="background: #e8f5e9; border-left: 4px solid #4CAF50; padding: 16px;">
          <strong style="color: #2e7d32;">✅ Normal Authentication Query</strong><br>
          <strong>What happens:</strong> Database checks if email and password match<br>
          <strong>Database returns:</strong> 0 rows (no match) or 1 row (valid user)<br>
          <strong>Result:</strong> Secure authentication - only valid credentials work
        </div>`;
      }
      
      resultDiv.innerHTML = analysis;
    }
    
    function loadSample(type) {
      const emailInput = document.getElementById('emailTest');
      const passwordInput = document.getElementById('passwordTest');
      const resultDiv = document.getElementById('queryResult');
      
      switch(type) {
        case 'normal':
          emailInput.value = 'john.doe@company.com';
          passwordInput.value = 'mySecurePassword123';
          setTimeout(() => {
            resultDiv.innerHTML = `
              <div style="background: #e8f5e9; border-left: 4px solid #4CAF50; padding: 16px;">
                <strong style="color: #2e7d32;">✅ Normal Authentication</strong><br>
                <strong>Query Result:</strong> 0 or 1 user record returned<br>
                <strong>Behavior:</strong> If credentials match, user logs in. If not, authentication fails.<br>
                <strong>Database sees:</strong> A normal query checking for one specific user
              </div>`;
          }, 100);
          break;
        case 'bypass':
          emailInput.value = "admin' OR '1'='1";
          passwordInput.value = "anything";
          setTimeout(() => {
            resultDiv.innerHTML = `
              <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 16px;">
                <strong style="color: #c62828;">🚨 AUTHENTICATION BYPASS ATTACK!</strong><br>
                <strong>Query Result:</strong> ALL user records returned (could be thousands!)<br>
                <strong>Attack Impact:</strong> Attacker logs in as the first user (often admin)<br>
                <strong>Why it works:</strong> The OR '1'='1' condition is always TRUE, so the query returns every user in the database<br>
                <strong>Real damage:</strong> Complete authentication bypass - attacker gains unauthorized access!
              </div>`;
          }, 100);
          break;
        case 'union':
          emailInput.value = "user@test.com' UNION SELECT username,password FROM admin_users--";
          passwordInput.value = "ignored";
          setTimeout(() => {
            resultDiv.innerHTML = `
              <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 16px;">
                <strong style="color: #c62828;">💀 ADVANCED DATA EXTRACTION ATTACK!</strong><br>
                <strong>Query Result:</strong> Attacker extracts data from OTHER tables<br>
                <strong>Attack Impact:</strong> Can steal usernames, passwords, credit cards, personal data<br>
                <strong>Why it works:</strong> UNION combines results from multiple queries, exposing sensitive data<br>
                <strong>Real damage:</strong> Complete data breach - all admin credentials exposed!<br>
                <div style="background: #1e1e1e; color: #ff9999; padding: 8px; margin-top: 8px; border-radius: 4px; font-family: monospace;">
                  admin_user1 | $2b$10$hashedpassword...<br>
                  admin_user2 | $2b$10$anotherhashedpw...<br>
                  superadmin | $2b$10$superadminpw...
                </div>
              </div>`;
          }, 100);
          break;
      }
      
      updateQuery();
    }
    
    // SQL Injection Decision Handler
    function ransomwareDecision(choice) {
      const ransomKey = `sql_injection_decision`;
      
      const feedbackDiv = document.getElementById('ransomwareFeedback');
      const buttons = document.querySelectorAll('#slide3 .decision-btn');
      
      // Save the choice
      gameState.choices[ransomKey] = choice;
      saveChoice(ransomKey, choice);
      
      feedbackDiv.innerHTML = '';
      
      // Clear all button styling and indicators first
      buttons.forEach(btn => {
        btn.style.background = '';
        btn.style.color = '';
        btn.style.fontWeight = '';
        btn.style.border = '';
        btn.style.opacity = '';
        btn.style.transform = '';
        btn.style.boxShadow = '';
        btn.style.position = '';
        btn.style.zIndex = '';
        // Remove any existing indicators
        const existingIndicator = btn.querySelector('.action-indicator');
        if (existingIndicator) existingIndicator.remove();
        const existingLabel = btn.querySelector('.action-label');
        if (existingLabel) existingLabel.remove();
      });
      
      // Find the clicked button
      let clickedButton;
      buttons.forEach(btn => {
        if ((choice === 'validation' && btn.textContent.includes('Missing input validation')) ||
            (choice === 'concatenation' && btn.textContent.includes('String concatenation')) ||
            (choice === 'async' && btn.textContent.includes('async/await')) ||
            (choice === 'password' && btn.textContent.includes('plain text passwords'))) {
          clickedButton = btn;
        }
      });
      
      // Make non-selected buttons slightly faded but still readable
      buttons.forEach(btn => {
        if (btn !== clickedButton) {
          btn.style.opacity = '0.7';
          btn.style.transform = 'scale(0.98)';
        }
      });
      
      switch(choice) {
        case 'validation':
          feedbackDiv.innerHTML = `<div class="feedback incorrect" style="display:block;">
            ❌ Input validation helps but is not the root cause. The string concatenation is the vulnerability.
          </div>`;
          if (clickedButton) {
            clickedButton.style.background = 'linear-gradient(135deg, #f44336, #C62828)';
            clickedButton.style.color = 'white';
            clickedButton.style.fontWeight = 'bold';
            clickedButton.style.border = '4px solid #C62828';
            clickedButton.style.transform = 'scale(1.12)';
            clickedButton.style.boxShadow = '0 8px 30px rgba(244,67,54,0.4), 0 0 25px rgba(244,67,54,0.3)';
            clickedButton.style.opacity = '1';
            clickedButton.style.position = 'relative';
            clickedButton.style.zIndex = '100';
            
            const icon = document.createElement('span');
            icon.className = 'action-indicator';
            icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
            icon.textContent = '❌';
            clickedButton.insertBefore(icon, clickedButton.firstChild);
            
            const label = document.createElement('div');
            label.className = 'action-label';
            label.style.cssText = `
              position: absolute;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              background: #f44336;
              color: white;
              padding: 4px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: bold;
              white-space: nowrap;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            label.textContent = '🎯 YOUR CHOICE';
            clickedButton.appendChild(label);
          }
          break;
        case 'concatenation':
          feedbackDiv.innerHTML = `<div class="feedback correct" style="display:block;">
            ✅ CORRECT! String concatenation creates SQL injection vulnerabilities!<br><br>
            <strong>The vulnerability:</strong><br>
            • User input is directly concatenated into the SQL query<br>
            • An attacker could pass: <code>admin' OR '1'='1</code><br>
            • This would return ALL users, not just the one with that email<br><br>
            <strong>How to fix:</strong><br>
            • Use parameterized queries: <code>SELECT * FROM users WHERE email = ?</code><br>
            • Use an ORM with built-in protection<br>
            • Never concatenate user input into queries
          </div>`;
          if (clickedButton) {
            clickedButton.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
            clickedButton.style.color = 'white';
            clickedButton.style.fontWeight = 'bold';
            clickedButton.style.border = '4px solid #2E7D32';
            clickedButton.style.transform = 'scale(1.12)';
            clickedButton.style.boxShadow = '0 8px 30px rgba(76,175,80,0.4), 0 0 25px rgba(76,175,80,0.3)';
            clickedButton.style.opacity = '1';
            clickedButton.style.position = 'relative';
            clickedButton.style.zIndex = '100';
            
            const icon = document.createElement('span');
            icon.className = 'action-indicator';
            icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
            icon.textContent = '✅';
            clickedButton.insertBefore(icon, clickedButton.firstChild);
            
            const label = document.createElement('div');
            label.className = 'action-label';
            label.style.cssText = `
              position: absolute;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              background: #4CAF50;
              color: white;
              padding: 4px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: bold;
              white-space: nowrap;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            label.textContent = '🎯 YOUR CHOICE';
            clickedButton.appendChild(label);
          }
          showAchievement('🔍', 'Vulnerability Hunter', 'Found the SQL injection!');
          gameState.ransomwareComplete = true;
          document.getElementById('ransomwareContinue').style.display = 'inline-flex';
          document.querySelectorAll('#slide3 .decision-btn').forEach(btn => {
            btn.disabled = true;
            btn.classList.add('disabled');
          });
          // Show interactive demo
          document.getElementById('vulnerability-arrow').style.display = 'inline';
          document.getElementById('sqlDemo').style.display = 'block';
          break;
        case 'async':
          feedbackDiv.innerHTML = `<div class="feedback incorrect" style="display:block;">
            ❌ Async/await is perfectly secure. The issue is how the SQL query is constructed.
          </div>`;
          if (clickedButton) {
            clickedButton.style.background = 'linear-gradient(135deg, #f44336, #C62828)';
            clickedButton.style.color = 'white';
            clickedButton.style.fontWeight = 'bold';
            clickedButton.style.border = '4px solid #C62828';
            clickedButton.style.transform = 'scale(1.12)';
            clickedButton.style.boxShadow = '0 8px 30px rgba(244,67,54,0.4), 0 0 25px rgba(244,67,54,0.3)';
            clickedButton.style.opacity = '1';
            clickedButton.style.position = 'relative';
            clickedButton.style.zIndex = '100';
            
            const icon = document.createElement('span');
            icon.className = 'action-indicator';
            icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
            icon.textContent = '❌';
            clickedButton.insertBefore(icon, clickedButton.firstChild);
            
            const label = document.createElement('div');
            label.className = 'action-label';
            label.style.cssText = `
              position: absolute;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              background: #f44336;
              color: white;
              padding: 4px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: bold;
              white-space: nowrap;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            label.textContent = '🎯 YOUR CHOICE';
            clickedButton.appendChild(label);
          }
          break;
        case 'password':
          feedbackDiv.innerHTML = `<div class="feedback incorrect" style="display:block;">
            ❌ That's another issue, but the immediate SQL injection vulnerability is from string concatenation!
          </div>`;
          if (clickedButton) {
            clickedButton.style.background = 'linear-gradient(135deg, #f44336, #C62828)';
            clickedButton.style.color = 'white';
            clickedButton.style.fontWeight = 'bold';
            clickedButton.style.border = '4px solid #C62828';
            clickedButton.style.transform = 'scale(1.12)';
            clickedButton.style.boxShadow = '0 8px 30px rgba(244,67,54,0.4), 0 0 25px rgba(244,67,54,0.3)';
            clickedButton.style.opacity = '1';
            clickedButton.style.position = 'relative';
            clickedButton.style.zIndex = '100';
            
            const icon = document.createElement('span');
            icon.className = 'action-indicator';
            icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
            icon.textContent = '❌';
            clickedButton.insertBefore(icon, clickedButton.firstChild);
            
            const label = document.createElement('div');
            label.className = 'action-label';
            label.style.cssText = `
              position: absolute;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              background: #f44336;
              color: white;
              padding: 4px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: bold;
              white-space: nowrap;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            label.textContent = '🎯 YOUR CHOICE';
            clickedButton.appendChild(label);
          }
          break;
      }
    }
    
    function showWarning() {
      alert('🚨 NEVER install plugins from websites! This is how watering hole attacks spread malware.');
    }
    
    // URL detection game
    // Move urlsChecked to gameState for proper persistence
    function checkURL(element, url, isSuspicious) {
      if (!gameState.urlsChecked) gameState.urlsChecked = [];
      
      // Check if already clicked - if so, just show feedback
      if (gameState.urlsChecked.includes(url)) {
        // Already checked - just show the visual feedback again
        if (isSuspicious) {
          alert('✅ You already identified this suspicious URL!');
        } else {
          alert('✅ You already checked this legitimate URL.');
        }
        return;
      }
      
      gameState.urlsChecked.push(url);
      const urlKey = `url_${url}`;
      gameState.choices[urlKey] = true;
      saveChoice(urlKey, true);
      
      if (isSuspicious) {
        element.classList.add('correct');
        gameState.urlsFound++;
        
        if (gameState.urlsFound === 1) {
          showAchievement('👁️', 'Sharp Eye', 'Found your first suspicious URL!');
        }
      } else {
        element.classList.add('incorrect');
      }
      
      document.getElementById('urlScore').textContent = gameState.urlsFound + '/' + gameState.totalSuspiciousUrls;
      
      if (gameState.urlsFound === gameState.totalSuspiciousUrls) {
        showAchievement('🔍', 'URL Master', 'Found all suspicious URLs!');
        document.getElementById('urlContinue').style.display = 'inline-flex';
      }
    }
    
    // Response simulation
    
    // Interactive Code Review Functions
    let currentReviewMode = 'analyze';
    let analyzedLines = new Set();
    let foundIssues = [];
    
    function setReviewMode(mode) {
      currentReviewMode = mode;
      
      // Save the current mode
      gameState.choices['code_review_mode'] = mode;
      saveChoice('code_review_mode', mode);
      
      // Update button states
      document.getElementById('analyzeMode').style.background = mode === 'analyze' ? 'var(--primary-purple)' : '';
      document.getElementById('analyzeMode').style.color = mode === 'analyze' ? 'white' : '';
      
      document.getElementById('scanMode').style.background = mode === 'scan' ? 'var(--primary-purple)' : '';
      document.getElementById('scanMode').style.color = mode === 'scan' ? 'white' : '';
      
      document.getElementById('fixMode').style.background = mode === 'fix' ? 'var(--primary-purple)' : '';
      document.getElementById('fixMode').style.color = mode === 'fix' ? 'white' : '';
      
      // Update status
      const status = document.getElementById('codeReviewStatus');
      if (mode === 'analyze') {
        status.textContent = 'Code Review Tool - Click lines to analyze';
      } else if (mode === 'scan') {
        runSecurityScan();
      } else if (mode === 'fix') {
        showFixSuggestions();
      }
    }
    
    function analyzeCodeLine(lineNum) {
      if (currentReviewMode !== 'analyze') return;
      
      const line = document.querySelectorAll('.code-line')[lineNum];
      const analysis = document.getElementById(`analysis-${lineNum}`);
      const indicator = line.querySelector('.line-indicator');
      
      // Mark as analyzed
      analyzedLines.add(lineNum);
      line.classList.add('analyzed');
      
      // Show/hide analysis
      if (analysis) {
        const isVisible = analysis.style.display !== 'none';
        analysis.style.display = isVisible ? 'none' : 'block';
        
        if (!isVisible) {
          // Show indicator
          if (indicator) indicator.style.display = 'inline';
          
          // Apply severity styling
          if (lineNum === 0 || lineNum === 2) {
            line.classList.add('critical');
            foundIssues.push(lineNum);
          } else if (lineNum === 3 || lineNum === 5) {
            line.classList.add('safe');
          } else if (lineNum === 4) {
            // Line 4 uses the hardcoded secret - warning
            line.style.background = 'rgba(255,152,0,0.1)';
            line.style.borderLeft = '3px solid #ff9800';
          }
          
          // Check if all critical issues found
          if (foundIssues.includes(0) && foundIssues.includes(2)) {
            setTimeout(() => {
              document.getElementById('fixMode').disabled = false;
              showAchievement('🔍', 'Security Expert', 'Found all critical vulnerabilities!');
              document.getElementById('lockContinue').style.display = 'inline-flex';
              gameState.lockComplete = true;
            }, 500);
          }
        }
      }
      
      // Update progress
      const totalLines = 6;  // Lines 0-5 are clickable
      const progress = (analyzedLines.size / totalLines) * 100;
      document.getElementById('codeReviewStatus').textContent = 
        `Code Review Tool - Analyzed ${analyzedLines.size}/${totalLines} lines`;
      
      // Save state using the same pattern as other slides
      gameState.choices['code_review_analyzed'] = Array.from(analyzedLines);
      gameState.choices['code_review_issues'] = foundIssues;
      gameState.choices['code_review_mode'] = currentReviewMode;
      saveChoice('code_review_analyzed', Array.from(analyzedLines));
      saveChoice('code_review_issues', foundIssues);
    }
    
    function runSecurityScan() {
      const overlay = document.getElementById('scannerOverlay');
      const progressBar = document.getElementById('scanProgress');
      const report = document.getElementById('vulnerabilityReport');
      
      // Show scanner overlay
      overlay.style.display = 'block';
      progressBar.style.width = '0%';
      
      // Animate scan progress
      let progress = 0;
      const scanInterval = setInterval(() => {
        progress += 10;
        progressBar.style.width = progress + '%';
        
        // Scan each line with visual effect
        if (progress % 20 === 0) {
          const lineIndex = Math.floor(progress / 20) - 1;
          if (lineIndex >= 0 && lineIndex < 5) {
            const lines = document.querySelectorAll('.code-line');
            lines[lineIndex].classList.add('scanning-line');
            setTimeout(() => {
              lines[lineIndex].classList.remove('scanning-line');
            }, 1000);
          }
        }
        
        if (progress >= 100) {
          clearInterval(scanInterval);
          setTimeout(() => {
            overlay.style.display = 'none';
            showScanResults();
          }, 500);
        }
      }, 200);
    }
    
    function showScanResults() {
      const report = document.getElementById('vulnerabilityReport');
      const reportContent = document.getElementById('reportContent');
      
      reportContent.innerHTML = `
        <div style="display: grid; gap: 16px;">
          <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 12px; border-radius: 4px;">
            <strong style="color: #c62828;">🔴 CRITICAL - CWE-798: Use of Hard-coded Credentials</strong>
            <p style="margin: 8px 0 0 0; color: #666;">Line 1: JWT secret key hardcoded. Impact: Critical</p>
            <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">OWASP: A2:2017 - Broken Authentication</p>
          </div>
          
          <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 12px; border-radius: 4px;">
            <strong style="color: #c62828;">🔴 CRITICAL - CWE-532: Information Exposure Through Log Files</strong>
            <p style="margin: 8px 0 0 0; color: #666;">Line 2: Password and email (PII) logged in plain text. Impact: High</p>
            <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">OWASP: A3:2017 - Sensitive Data Exposure</p>
          </div>
          
          <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; border-radius: 4px;">
            <strong style="color: #f57c00;">⚠️ WARNING - Hardcoded Secret Usage</strong>
            <p style="margin: 8px 0 0 0; color: #666;">Line 4: Using hardcoded JWT_SECRET from line 1</p>
          </div>
          
          <div style="background: #e8f5e9; border-left: 4px solid #4CAF50; padding: 12px; border-radius: 4px;">
            <strong style="color: #2e7d32;">✅ PASS - Secure Password Handling</strong>
            <p style="margin: 8px 0 0 0; color: #666;">Line 3: Using bcrypt for password comparison</p>
          </div>
          
          <div style="margin-top: 16px; padding: 16px; background: #fff3e0; border-radius: 8px;">
            <strong>📊 Scan Summary:</strong>
            <p style="margin: 8px 0 0 0;">• 2 Critical vulnerabilities found</p>
            <p style="margin: 4px 0 0 0;">• Security Score: 40/100</p>
            <p style="margin: 4px 0 0 0;">• Recommendation: Fix critical issues immediately</p>
          </div>
        </div>
      `;
      
      report.style.display = 'block';
      
      // Enable fix mode
      document.getElementById('fixMode').disabled = false;
      
      // Auto-highlight issues in code
      const lines = document.querySelectorAll('.code-line');
      lines[0].classList.add('critical');  // JWT_SECRET hardcoded
      lines[2].classList.add('critical');  // console.log with password
      lines[3].classList.add('safe');     // bcrypt comparison
      lines[4].style.background = 'rgba(255,152,0,0.1)';  // Uses hardcoded secret
      lines[4].style.borderLeft = '3px solid #ff9800';
      lines[5].classList.add('safe');     // return statement
      
      // Show all analyses
      document.getElementById('analysis-0').style.display = 'block';
      document.getElementById('analysis-2').style.display = 'block';
      document.getElementById('analysis-4').style.display = 'block';
      
      // Save scan completion state
      gameState.choices['code_review_scan_complete'] = true;
      saveChoice('code_review_scan_complete', true);
      
      // Update status
      document.getElementById('codeReviewStatus').textContent = 'Security Scan Complete - 2 vulnerabilities found';
    }
    
    function showFixSuggestions() {
      const fixPanel = document.getElementById('fixPanel');
      const fixContent = document.getElementById('fixContent');
      
      fixContent.innerHTML = `
        <div style="display: grid; gap: 20px;">
          <div>
            <h4 style="color: #c62828; margin-bottom: 8px;">🔧 Fix #1: Remove PII and Passwords from Logs</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <strong style="color: #666;">❌ Current (Vulnerable):</strong>
                <pre style="background: #2d2d2d; color: #ff9999; padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 8px;">
console.log(\`Login for \${email} with password: \${password}\`);</pre>
              </div>
              <div>
                <strong style="color: #2e7d32;">✅ Fixed (Secure):</strong>
                <pre style="background: #2d2d2d; color: #81c784; padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 8px;">
console.log(\`Login attempt for user ID: \${userId}\`);
// Never log passwords, emails, or other PII!</pre>
              </div>
            </div>
          </div>
          
          <div>
            <h4 style="color: #c62828; margin-bottom: 8px;">🔧 Fix #2: Use AWS Secrets Manager for Secrets</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <strong style="color: #666;">❌ Current (Vulnerable):</strong>
                <pre style="background: #2d2d2d; color: #ff9999; padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 8px;">
const JWT_SECRET = "secret2024Key!";</pre>
              </div>
              <div>
                <strong style="color: #2e7d32;">✅ Fixed (Secure):</strong>
                <pre style="background: #2d2d2d; color: #81c784; padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 8px;">
const JWT_SECRET = await secretsManager.getSecret('jwt-secret');
// Managed in AWS Secrets Manager with rotation!</pre>
              </div>
            </div>
          </div>
          
          <div style="background: #e3f2fd; padding: 16px; border-radius: 8px;">
            <h4 style="color: var(--dark-purple); margin-bottom: 8px;">📚 Security Best Practices Applied:</h4>
            <ul style="margin: 0; padding-left: 20px; color: #666;">
              <li>Never log sensitive information (passwords, tokens, emails, or PII)</li>
              <li>Use user IDs instead of email addresses in logs</li>
              <li>Store secrets in AWS Secrets Manager</li>
              <li>Enable automatic secret rotation</li>
              <li>Use structured logging with severity levels</li>
              <li>Implement audit logging for security events</li>
            </ul>
          </div>
        </div>
      `;
      
      fixPanel.style.display = 'block';
      document.getElementById('lockContinue').style.display = 'inline-flex';
      
      // Save fixes shown state
      gameState.choices['code_review_fixes_shown'] = true;
      saveChoice('code_review_fixes_shown', true);
      
      // Update status
      document.getElementById('codeReviewStatus').textContent = 'Fix Mode - Remediation steps shown';
    }
    
    // Lock Decision Handler (Modified for new interactive version)
    function lockDecision(choice) {
      const lockKey = `lock_decision`;
      
      const feedbackDiv = document.getElementById('lockFeedback');
      const buttons = document.querySelectorAll('#slide4 .decision-btn');
      
      // Save the choice
      gameState.choices[lockKey] = choice;
      saveChoice(lockKey, choice);
      
      feedbackDiv.innerHTML = '';
      
      // Clear all button styling and indicators first
      buttons.forEach(btn => {
        btn.style.background = '';
        btn.style.color = '';
        btn.style.fontWeight = '';
        btn.style.border = '';
        btn.style.opacity = '';
        btn.style.transform = '';
        btn.style.boxShadow = '';
        btn.style.position = '';
        btn.style.zIndex = '';
        // Remove any existing indicators
        const existingIndicator = btn.querySelector('.action-indicator');
        if (existingIndicator) existingIndicator.remove();
        const existingLabel = btn.querySelector('.action-label');
        if (existingLabel) existingLabel.remove();
      });
      
      // Find the clicked button
      let clickedButton;
      buttons.forEach(btn => {
        if ((choice === 'line1' && btn.textContent.includes('Line 1')) ||
            (choice === 'line2' && btn.textContent.includes('Line 2')) ||
            (choice === 'line3' && btn.textContent.includes('Line 3')) ||
            (choice === 'line4' && btn.textContent.includes('Line 4'))) {
          clickedButton = btn;
        }
      });
      
      // Make non-selected buttons slightly faded but still readable
      buttons.forEach(btn => {
        if (btn !== clickedButton) {
          btn.style.opacity = '0.7';
          btn.style.transform = 'scale(0.98)';
        }
      });
      
      switch(choice) {
        case 'line2':
          feedbackDiv.innerHTML = `<div class="feedback incorrect" style="display:block;">
            ❌ bcrypt.compareSync is actually secure - it is the industry standard for password comparison.
          </div>`;
          if (clickedButton) {
            clickedButton.style.background = 'linear-gradient(135deg, #f44336, #C62828)';
            clickedButton.style.color = 'white';
            clickedButton.style.fontWeight = 'bold';
            clickedButton.style.border = '4px solid #C62828';
            clickedButton.style.transform = 'scale(1.12)';
            clickedButton.style.boxShadow = '0 8px 30px rgba(244,67,54,0.4), 0 0 25px rgba(244,67,54,0.3)';
            clickedButton.style.opacity = '1';
            clickedButton.style.position = 'relative';
            clickedButton.style.zIndex = '100';
            
            const icon = document.createElement('span');
            icon.className = 'action-indicator';
            icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
            icon.textContent = '❌';
            clickedButton.insertBefore(icon, clickedButton.firstChild);
            
            const label = document.createElement('div');
            label.className = 'action-label';
            label.style.cssText = `
              position: absolute;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              background: #f44336;
              color: white;
              padding: 4px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: bold;
              white-space: nowrap;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            label.textContent = '🎯 YOUR CHOICE';
            clickedButton.appendChild(label);
          }
          break;
        case 'line1':
          feedbackDiv.innerHTML = `<div class="feedback correct" style="display:block;">
            ✅ CRITICAL ISSUE! Logging passwords is a severe security vulnerability!<br><br>
            <strong>Why this is dangerous:</strong><br>
            • Passwords appear in plain text in log files<br>
            • Anyone with log access can see user passwords<br>
            • Logs are often shipped to multiple systems<br>
            • Violates compliance requirements (PCI-DSS, GDPR)<br><br>
            <strong>Note:</strong> Line 4 also has a critical issue (hard-coded secret key)!
          </div>`;
          if (clickedButton) {
            clickedButton.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
            clickedButton.style.color = 'white';
            clickedButton.style.fontWeight = 'bold';
            clickedButton.style.border = '4px solid #2E7D32';
            clickedButton.style.transform = 'scale(1.12)';
            clickedButton.style.boxShadow = '0 8px 30px rgba(76,175,80,0.4), 0 0 25px rgba(76,175,80,0.3)';
            clickedButton.style.opacity = '1';
            clickedButton.style.position = 'relative';
            clickedButton.style.zIndex = '100';
            
            const icon = document.createElement('span');
            icon.className = 'action-indicator';
            icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
            icon.textContent = '✅';
            clickedButton.insertBefore(icon, clickedButton.firstChild);
            
            const label = document.createElement('div');
            label.className = 'action-label';
            label.style.cssText = `
              position: absolute;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              background: #4CAF50;
              color: white;
              padding: 4px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: bold;
              white-space: nowrap;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            label.textContent = '🎯 YOUR CHOICE';
            clickedButton.appendChild(label);
          }
          showAchievement('🔍', 'Security Reviewer', 'Found critical security issues!');
          gameState.lockComplete = true;
          document.getElementById('lockContinue').style.display = 'inline-flex';
          document.querySelectorAll('#slide4 .decision-btn').forEach(btn => {
            btn.disabled = true;
            btn.classList.add('disabled');
          });
          break;
        case 'line3':
          feedbackDiv.innerHTML = `<div class="feedback incorrect" style="display:block;">
            ❌ Returning a boolean is normal and safe for authentication results.
          </div>`;
          if (clickedButton) {
            clickedButton.style.background = 'linear-gradient(135deg, #f44336, #C62828)';
            clickedButton.style.color = 'white';
            clickedButton.style.fontWeight = 'bold';
            clickedButton.style.border = '4px solid #C62828';
            clickedButton.style.transform = 'scale(1.12)';
            clickedButton.style.boxShadow = '0 8px 30px rgba(244,67,54,0.4), 0 0 25px rgba(244,67,54,0.3)';
            clickedButton.style.opacity = '1';
            clickedButton.style.position = 'relative';
            clickedButton.style.zIndex = '100';
            
            const icon = document.createElement('span');
            icon.className = 'action-indicator';
            icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
            icon.textContent = '❌';
            clickedButton.insertBefore(icon, clickedButton.firstChild);
            
            const label = document.createElement('div');
            label.className = 'action-label';
            label.style.cssText = `
              position: absolute;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              background: #f44336;
              color: white;
              padding: 4px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: bold;
              white-space: nowrap;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            label.textContent = '🎯 YOUR CHOICE';
            clickedButton.appendChild(label);
          }
          break;
        case 'line4':
          feedbackDiv.innerHTML = `<div class="feedback correct" style="display:block;">
            ✅ CRITICAL ISSUE! Hard-coded secret keys are a major vulnerability!<br><br>
            <strong>Why this is dangerous:</strong><br>
            • Anyone with code access can forge tokens<br>
            • Keys in source code get committed to version control<br>
            • Cannot rotate keys without code changes<br>
            • Same key used across all environments<br><br>
            <strong>Note:</strong> Line 1 also has a critical issue (logging passwords)!
          </div>`;
          if (clickedButton) {
            clickedButton.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
            clickedButton.style.color = 'white';
            clickedButton.style.fontWeight = 'bold';
            clickedButton.style.border = '4px solid #2E7D32';
            clickedButton.style.transform = 'scale(1.12)';
            clickedButton.style.boxShadow = '0 8px 30px rgba(76,175,80,0.4), 0 0 25px rgba(76,175,80,0.3)';
            clickedButton.style.opacity = '1';
            clickedButton.style.position = 'relative';
            clickedButton.style.zIndex = '100';
            
            const icon = document.createElement('span');
            icon.className = 'action-indicator';
            icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
            icon.textContent = '✅';
            clickedButton.insertBefore(icon, clickedButton.firstChild);
            
            const label = document.createElement('div');
            label.className = 'action-label';
            label.style.cssText = `
              position: absolute;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              background: #4CAF50;
              color: white;
              padding: 4px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: bold;
              white-space: nowrap;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            label.textContent = '🎯 YOUR CHOICE';
            clickedButton.appendChild(label);
          }
          showAchievement('🔍', 'Security Reviewer', 'Found critical security issues!');
          gameState.lockComplete = true;
          document.getElementById('lockContinue').style.display = 'inline-flex';
          document.querySelectorAll('#slide4 .decision-btn').forEach(btn => {
            btn.disabled = true;
            btn.classList.add('disabled');
          });
          break;
      }
    }
    
    // Dependency Decision Handler
    function dependencyDecision(choice) {
      const depKey = `dependency_decision`;
      
      const feedbackDiv = document.getElementById('passwordCompleteFeedback');
      const buttons = document.querySelectorAll('#slide5 .decision-btn');
      
      // Save the choice
      gameState.choices[depKey] = choice;
      saveChoice(depKey, choice);
      
      feedbackDiv.innerHTML = '';
      
      // Clear all button styling and indicators first
      buttons.forEach(btn => {
        btn.style.background = '';
        btn.style.color = '';
        btn.style.fontWeight = '';
        btn.style.border = '';
        btn.style.opacity = '';
        btn.style.transform = '';
        btn.style.boxShadow = '';
        btn.style.position = '';
        btn.style.zIndex = '';
        // Remove any existing indicators
        const existingIndicator = btn.querySelector('.action-indicator');
        if (existingIndicator) existingIndicator.remove();
        const existingLabel = btn.querySelector('.action-label');
        if (existingLabel) existingLabel.remove();
      });
      
      // Find the clicked button
      let clickedButton;
      buttons.forEach((btn, index) => {
        if ((choice === 'ignore' && index === 0) ||
            (choice === 'later' && index === 1) ||
            (choice === 'update' && index === 2) ||
            (choice === 'research' && index === 3)) {
          clickedButton = btn;
        }
      });
      
      // Make non-selected buttons slightly faded but still readable
      buttons.forEach(btn => {
        if (btn !== clickedButton) {
          btn.style.opacity = '0.7';
          btn.style.transform = 'scale(0.98)';
        }
      });
      
      if (choice === 'update') {
        feedbackDiv.innerHTML = `<div class="feedback correct" style="display:block;">
          ✅ CORRECT! Critical vulnerabilities must be patched immediately!<br><br>
          <strong>Why immediate action is required:</strong><br>
          • CVE-2023-26469 allows remote code execution (CVSS 9.8!)<br>
          • These vulnerabilities are publicly known and actively exploited<br>
          • Automated tools scan for these exact versions<br><br>
          <strong>Best practices:</strong><br>
          • Block deployment if critical CVEs are found<br>
          • Update and thoroughly test the changes<br>
          • Use automated dependency scanning in CI/CD<br>
          • Maintain a Software Bill of Materials (SBOM)
        </div>`;
        if (clickedButton) {
          clickedButton.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
          clickedButton.style.color = 'white';
          clickedButton.style.fontWeight = 'bold';
          clickedButton.style.border = '4px solid #2E7D32';
          clickedButton.style.transform = 'scale(1.12)';
          clickedButton.style.boxShadow = '0 8px 30px rgba(76,175,80,0.4), 0 0 25px rgba(76,175,80,0.3)';
          clickedButton.style.opacity = '1';
          clickedButton.style.position = 'relative';
          clickedButton.style.zIndex = '100';
          
          const icon = document.createElement('span');
          icon.className = 'action-indicator';
          icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
          icon.textContent = '✅';
          clickedButton.insertBefore(icon, clickedButton.firstChild);
          
          const label = document.createElement('div');
          label.className = 'action-label';
          label.style.cssText = `
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          `;
          label.textContent = '🎯 YOUR CHOICE';
          clickedButton.appendChild(label);
        }
        showAchievement('🔒', 'Dependency Guardian', 'Protected against known vulnerabilities!');
        gameState.passwordComplete = true;
        document.getElementById('passwordContinue').style.display = 'inline-flex';
        document.querySelectorAll('#slide5 .decision-btn').forEach(btn => {
          btn.disabled = true;
          btn.classList.add('disabled');
        });
      } else {
        const wrongReasons = {
          'ignore': 'Dev dependencies can still be exploited! They run on developer machines and CI systems.',
          'later': 'Too risky! Critical vulnerabilities are actively exploited. Every day of delay increases risk.',
          'research': 'With a CVSS score of 9.8, assume you ARE affected. Patch first, then verify.'
        };
        feedbackDiv.innerHTML = `<div class="feedback incorrect" style="display:block;">
          ❌ ${wrongReasons[choice] || 'Try again!'}
        </div>`;
        if (clickedButton) {
          clickedButton.style.background = 'linear-gradient(135deg, #f44336, #C62828)';
          clickedButton.style.color = 'white';
          clickedButton.style.fontWeight = 'bold';
          clickedButton.style.border = '4px solid #C62828';
          clickedButton.style.transform = 'scale(1.12)';
          clickedButton.style.boxShadow = '0 8px 30px rgba(244,67,54,0.4), 0 0 25px rgba(244,67,54,0.3)';
          clickedButton.style.opacity = '1';
          clickedButton.style.position = 'relative';
          clickedButton.style.zIndex = '100';
          
          const icon = document.createElement('span');
          icon.className = 'action-indicator';
          icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
          icon.textContent = '❌';
          clickedButton.insertBefore(icon, clickedButton.firstChild);
          
          const label = document.createElement('div');
          label.className = 'action-label';
          label.style.cssText = `
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          `;
          label.textContent = '🎯 YOUR CHOICE';
          clickedButton.appendChild(label);
        }
      }
    }
    
    // Placeholder functions for removed password functionality
    function showPasswordWarning() {}
    function checkPasswordStrength() {
      const password = document.getElementById('passwordInput').value;
      const strengthBar = document.getElementById('strengthBar');
      const feedback = document.getElementById('strengthFeedback');
      const completeFeedback = document.getElementById('passwordCompleteFeedback');
      
      let strength = 0;
      let strengthText = '';
      let strengthColor = '';
      let barWidth = '0%';
      
      // Check requirements
      const hasLength = password.length >= 12;
      const hasUpper = /[A-Z]/.test(password);
      const hasLower = /[a-z]/.test(password);
      const hasNumber = /[0-9]/.test(password);
      const hasSpecial = /[^a-zA-Z0-9]/.test(password);
      
      // Update requirement indicators
      document.getElementById('req-length').style.color = hasLength ? '#4CAF50' : '#999';
      document.getElementById('req-upper').style.color = hasUpper ? '#4CAF50' : '#999';
      document.getElementById('req-lower').style.color = hasLower ? '#4CAF50' : '#999';
      document.getElementById('req-number').style.color = hasNumber ? '#4CAF50' : '#999';
      document.getElementById('req-special').style.color = hasSpecial ? '#4CAF50' : '#999';
      
      // Calculate strength
      if (hasLength) strength += 2;
      else if (password.length >= 8) strength += 1;
      
      if (hasLower) strength += 1;
      if (hasUpper) strength += 1;
      if (hasNumber) strength += 1;
      if (hasSpecial) strength += 1;
      
      // Common patterns check
      if (password.length > 0 && !/password|123456|qwerty|welcome|admin/i.test(password)) {
        strength += 1;
      }
      
      // Determine strength level
      if (password.length === 0) {
        strengthText = '';
        strengthColor = '#ddd';
        barWidth = '0%';
      } else if (strength <= 2) {
        strengthText = '❌ Weak';
        strengthColor = '#f44336';
        barWidth = '25%';
        strengthBar.style.background = 'linear-gradient(90deg, #f44336, #C62828)';
      } else if (strength <= 4) {
        strengthText = '⚠️ Medium';
        strengthColor = '#ff9800';
        barWidth = '50%';
        strengthBar.style.background = 'linear-gradient(90deg, #ff9800, #E65100)';
      } else if (strength <= 6) {
        strengthText = '👍 Strong';
        strengthColor = '#8BC34A';
        barWidth = '75%';
        strengthBar.style.background = 'linear-gradient(90deg, #8BC34A, #689F38)';
      } else {
        strengthText = '💪 Very Strong';
        strengthColor = '#4CAF50';
        barWidth = '100%';
        strengthBar.style.background = 'linear-gradient(90deg, #4CAF50, #2E7D32)';
        
        // Check if they tested a strong password example
        if (hasLength && hasUpper && hasLower && hasNumber && hasSpecial) {
          // Show success for very strong passwords
          if (!gameState.passwordComplete && password === 'Coffee#Sunrise&Mountain47!') {
            completeFeedback.innerHTML = `<div class="feedback correct" style="display:block;">
              ✅ Excellent! You've discovered what makes a Very Strong password!<br>
              • Length + uppercase + lowercase + numbers + symbols = maximum security<br>
              • Use passphrases or a password manager for all accounts<br>
              • NEVER reuse passwords across different services
            </div>`;
            showAchievement('🔐', 'Password Expert', 'Learned to identify strong passwords!');
            gameState.passwordComplete = true;
            document.getElementById('passwordContinue').style.display = 'inline-flex';
            
            // Save the achievement
            const passKey = 'password_strength_achieved';
            gameState.choices[passKey] = true;
            saveChoice(passKey, true);
          }
        }
      }
      
      // Update UI
      strengthBar.style.width = barWidth;
      feedback.textContent = strengthText;
      feedback.style.color = strengthColor;
    }
    
    // Software Compliance Decision Handler
    function softwareDecision(choice) {
      const softKey = `software_decision`;
      
      const feedbackDiv = document.getElementById('softwareFeedback');
      const buttons = document.querySelectorAll('#slide9 .decision-btn');
      
      // Save the choice
      gameState.choices[softKey] = choice;
      saveChoice(softKey, choice);
      
      feedbackDiv.innerHTML = '';
      
      // Clear all button styling and indicators first
      buttons.forEach(btn => {
        btn.style.background = '';
        btn.style.color = '';
        btn.style.fontWeight = '';
        btn.style.border = '';
        btn.style.opacity = '';
        btn.style.transform = '';
        btn.style.boxShadow = '';
        btn.style.position = '';
        btn.style.zIndex = '';
        // Remove any existing indicators
        const existingIndicator = btn.querySelector('.action-indicator');
        if (existingIndicator) existingIndicator.remove();
        const existingLabel = btn.querySelector('.action-label');
        if (existingLabel) existingLabel.remove();
      });
      
      // Find the clicked button
      let clickedButton;
      buttons.forEach(btn => {
        if ((choice === 'csp' && btn.textContent.includes('Content-Security-Policy')) ||
            (choice === 'xframe' && btn.textContent.includes('X-Frame-Options')) ||
            (choice === 'hsts' && btn.textContent.includes('Strict-Transport-Security')) ||
            (choice === 'xcontent' && btn.textContent.includes('X-Content-Type-Options'))) {
          clickedButton = btn;
        }
      });
      
      // Make non-selected buttons slightly faded but still readable
      buttons.forEach(btn => {
        if (btn !== clickedButton) {
          btn.style.opacity = '0.7';
          btn.style.transform = 'scale(0.98)';
        }
      });
      
      switch(choice) {
        case 'csp':
          feedbackDiv.innerHTML = `<div class="feedback correct" style="display:block;">
            ✅ CORRECT! Content-Security-Policy is the most critical header for preventing XSS attacks!<br><br>
            <strong>Why CSP is priority #1:</strong><br>
            • Prevents inline script execution and XSS attacks<br>
            • Blocks unauthorized resource loading<br>
            • Critical for APIs serving sensitive data<br><br>
            <strong>Implementation:</strong><br>
            <code>Content-Security-Policy: default-src 'self'; script-src 'self';</code>
          </div>`;
          if (clickedButton) {
            clickedButton.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
            clickedButton.style.color = 'white';
            clickedButton.style.fontWeight = 'bold';
            clickedButton.style.border = '4px solid #2E7D32';
            clickedButton.style.transform = 'scale(1.12)';
            clickedButton.style.boxShadow = '0 8px 30px rgba(76,175,80,0.4), 0 0 25px rgba(76,175,80,0.3)';
            clickedButton.style.opacity = '1';
            clickedButton.style.position = 'relative';
            clickedButton.style.zIndex = '100';
            
            const icon = document.createElement('span');
            icon.className = 'action-indicator';
            icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
            icon.textContent = '✅';
            clickedButton.insertBefore(icon, clickedButton.firstChild);
            
            const label = document.createElement('div');
            label.className = 'action-label';
            label.style.cssText = `
              position: absolute;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              background: #4CAF50;
              color: white;
              padding: 4px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: bold;
              white-space: nowrap;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            label.textContent = '🎯 YOUR CHOICE';
            clickedButton.appendChild(label);
          }
          showAchievement('🛡️', 'Security Headers Expert', 'Prioritized the right security header!');
          gameState.softwareComplete = true;
          document.getElementById('softwareContinue').style.display = 'inline-flex';
          document.querySelectorAll('#slide9 .decision-btn').forEach(btn => {
            btn.disabled = true;
            btn.classList.add('disabled');
          });
          break;
        case 'xframe':
          feedbackDiv.innerHTML = `<div class="feedback incorrect" style="display:block;">
            ❌ Important but not first priority. X-Frame-Options prevents clickjacking, but CSP is more critical for API security.
          </div>`;
          if (clickedButton) {
            clickedButton.style.background = 'linear-gradient(135deg, #f44336, #C62828)';
            clickedButton.style.color = 'white';
            clickedButton.style.fontWeight = 'bold';
            clickedButton.style.border = '4px solid #C62828';
            clickedButton.style.transform = 'scale(1.12)';
            clickedButton.style.boxShadow = '0 8px 30px rgba(244,67,54,0.4), 0 0 25px rgba(244,67,54,0.3)';
            clickedButton.style.opacity = '1';
            clickedButton.style.position = 'relative';
            clickedButton.style.zIndex = '100';
            
            const icon = document.createElement('span');
            icon.className = 'action-indicator';
            icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
            icon.textContent = '❌';
            clickedButton.insertBefore(icon, clickedButton.firstChild);
            
            const label = document.createElement('div');
            label.className = 'action-label';
            label.style.cssText = `
              position: absolute;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              background: #f44336;
              color: white;
              padding: 4px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: bold;
              white-space: nowrap;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            label.textContent = '🎯 YOUR CHOICE';
            clickedButton.appendChild(label);
          }
          break;
        case 'hsts':
          feedbackDiv.innerHTML = `<div class="feedback incorrect" style="display:block;">
            ❌ HSTS is important for forcing HTTPS, but CSP should be implemented first to prevent XSS.
          </div>`;
          if (clickedButton) {
            clickedButton.style.background = 'linear-gradient(135deg, #f44336, #C62828)';
            clickedButton.style.color = 'white';
            clickedButton.style.fontWeight = 'bold';
            clickedButton.style.border = '4px solid #C62828';
            clickedButton.style.transform = 'scale(1.12)';
            clickedButton.style.boxShadow = '0 8px 30px rgba(244,67,54,0.4), 0 0 25px rgba(244,67,54,0.3)';
            clickedButton.style.opacity = '1';
            clickedButton.style.position = 'relative';
            clickedButton.style.zIndex = '100';
            
            const icon = document.createElement('span');
            icon.className = 'action-indicator';
            icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
            icon.textContent = '❌';
            clickedButton.insertBefore(icon, clickedButton.firstChild);
            
            const label = document.createElement('div');
            label.className = 'action-label';
            label.style.cssText = `
              position: absolute;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              background: #f44336;
              color: white;
              padding: 4px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: bold;
              white-space: nowrap;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            label.textContent = '🎯 YOUR CHOICE';
            clickedButton.appendChild(label);
          }
          break;
        case 'xcontent':
          feedbackDiv.innerHTML = `<div class="feedback incorrect" style="display:block;">
            ❌ X-Content-Type-Options prevents MIME sniffing but CSP provides broader XSS protection.
          </div>`;
          if (clickedButton) {
            clickedButton.style.background = 'linear-gradient(135deg, #f44336, #C62828)';
            clickedButton.style.color = 'white';
            clickedButton.style.fontWeight = 'bold';
            clickedButton.style.border = '4px solid #C62828';
            clickedButton.style.transform = 'scale(1.12)';
            clickedButton.style.boxShadow = '0 8px 30px rgba(244,67,54,0.4), 0 0 25px rgba(244,67,54,0.3)';
            clickedButton.style.opacity = '1';
            clickedButton.style.position = 'relative';
            clickedButton.style.zIndex = '100';
            
            const icon = document.createElement('span');
            icon.className = 'action-indicator';
            icon.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
            icon.textContent = '❌';
            clickedButton.insertBefore(icon, clickedButton.firstChild);
            
            const label = document.createElement('div');
            label.className = 'action-label';
            label.style.cssText = `
              position: absolute;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              background: #f44336;
              color: white;
              padding: 4px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: bold;
              white-space: nowrap;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            label.textContent = '🎯 YOUR CHOICE';
            clickedButton.appendChild(label);
          }
          break;
      }
    }
    
    // Knowledge check scenarios
    function loadScenarios() {
      const scenarios = [
        {
          title: 'Malware Prevention',
          type: 'malware',
          description: 'A colleague receives a USB from a conference labeled "Conference Workshop Materials". What should they do?',
          options: [
            { text: 'Plug it into their work computer to check the contents', feedback: 'Never plug unknown USBs into work computers - they can auto-execute malware.', correct: false },
            { text: 'Report it to security@yourcompany.com for proper scanning', feedback: 'Correct! Security team has isolated systems to safely check unknown devices.', correct: true },
            { text: 'Use a personal laptop to check it first', feedback: 'Personal devices can still spread malware to corporate networks.', correct: false }
          ]
        },
        {
          title: 'Device Security',
          type: 'device',
          description: 'You\'re in a conference room for a 5-minute break. Your laptop shows confidential company architecture. What do you do?',
          options: [
            { text: 'Ask a colleague to watch it while you\'re gone', feedback: 'Even trusted colleagues shouldn\'t have unsupervised access.', correct: false },
            { text: 'Leave it open since it\'s just 5 minutes', feedback: 'Never leave devices unlocked - attacks happen in seconds.', correct: false },
            { text: 'Lock the screen using Win+L or Cmd+Ctrl+Q', feedback: 'Perfect! Always lock screens when stepping away, even briefly.', correct: true }
          ]
        },
        {
          title: 'Password Security',
          type: 'password',
          description: 'Your team needs to share access to a a web application organization account. Best approach?',
          options: [
            { text: 'Share the password via encrypted email', feedback: 'Never share passwords via email, even encrypted.', correct: false },
            { text: 'Use organization\'s SSO and grant individual access permissions', feedback: 'Excellent! SSO provides individual accountability and security.', correct: true },
            { text: 'Store the password in a shared document', feedback: 'Shared documents are not secure for password storage.', correct: false }
          ]
        },
        {
          title: 'Software Compliance',
          type: 'software',
          description: 'A developer wants to use a new code analysis tool they found online. What\'s the correct process?',
          options: [
            { text: 'Install it immediately if it\'s open source', feedback: 'Open source doesn\'t mean safe - needs security review.', correct: false },
            { text: 'Test it on a personal device first', feedback: 'Personal testing doesn\'t validate security for corporate use.', correct: false },
            { text: 'Submit it for security review before installation', feedback: 'Correct! All software needs security review before use.', correct: true }
          ]
        }
      ];
      
      const container = document.getElementById('scenarioContainer');
      
      // Clear existing scenarios to prevent duplicates
      container.innerHTML = '';
      
      scenarios.forEach((scenario, index) => {
        const scenarioDiv = document.createElement('div');
        scenarioDiv.style.cssText = 'background:#f8f9fa;padding:24px;border-radius:12px;margin-bottom:24px;border:2px solid #dee2e6;';
        
        const icon = scenario.type === 'plugin' ? '🔌' : scenario.type === 'redirect' ? '🔄' : '🚨';
        
        scenarioDiv.innerHTML = `
          <h3 style="color:var(--dark-purple);margin-bottom:16px;">${icon} Scenario ${index + 1}: ${scenario.title}</h3>
          <p style="margin-bottom:20px;font-style:italic;">${scenario.description}</p>
          <div id="scenario${index}Options" style="display:grid;gap:12px;">
            ${scenario.options.map((opt, i) => 
              `<button class="btn btn-secondary" style="text-align:left;padding:16px;" onclick="scenarioResponse(${index}, ${i})">${opt.text}</button>`
            ).join('')}
          </div>
          <div id="scenario${index}Feedback" style="margin-top:16px;"></div>
        `;
        
        container.appendChild(scenarioDiv);
      });
    }
    
    function scenarioResponse(scenarioIndex, optionIndex) {
      const choiceKey = `scenario_${scenarioIndex}`;
      
      // Save the choice
      gameState.choices[choiceKey] = optionIndex;
      saveChoice(choiceKey, optionIndex);
      const scenarios = [
        {
          options: [
            { feedback: 'Correct — malicious prompts on trusted sites are a hallmark of watering hole attacks.', correct: true },
            { feedback: 'Hangs can happen for many benign reasons. Not sufficient by itself.', correct: false },
            { feedback: 'Maintenance happens; not evidence of compromise on its own.', correct: false }
          ]
        },
        {
          options: [
            { feedback: 'Appearance can be spoofed; don\'t trust looks alone.', correct: false },
            { feedback: 'Correct — verify the URL and use trusted bookmarks to avoid look‑alike domains.', correct: true },
            { feedback: 'Never enter credentials on a suspicious page.', correct: false }
          ]
        },
        {
          options: [
            { feedback: 'Correct — report to Security and isolate impacted systems.', correct: true },
            { feedback: 'Public posts can tip attackers or cause confusion; use internal channels.', correct: false },
            { feedback: 'Never install unverified updates suggested by websites.', correct: false }
          ]
        }
      ];
      
      const scenario = scenarios[scenarioIndex];
      const option = scenario.options[optionIndex];
      const feedbackDiv = document.getElementById(`scenario${scenarioIndex}Feedback`);
      const buttons = document.querySelectorAll(`#scenario${scenarioIndex}Options button`);
      
      // Clear previous styling from all buttons first
      buttons.forEach(btn => {
        btn.style.background = '';
        btn.style.color = '';
        btn.style.fontWeight = '';
        btn.style.border = '';
        btn.style.opacity = '';
      });
      
      // Highlight the selected button
      buttons[optionIndex].style.background = option.correct ? 'linear-gradient(135deg, #4CAF50, #45a049)' : 'linear-gradient(135deg, #ff9800, #f57c00)';
      buttons[optionIndex].style.color = 'white';
      buttons[optionIndex].style.fontWeight = '600';
      buttons[optionIndex].style.border = option.correct ? '2px solid #4CAF50' : '2px solid #ff9800';
      
      if (option.correct) {
        feedbackDiv.innerHTML = `<div class="feedback correct" style="display:block;">
          ✅ ${option.feedback}
        </div>`;
        
        // Disable all buttons for this scenario ONLY after correct answer
        buttons.forEach(btn => {
          btn.disabled = true;
          btn.classList.add('disabled');
        });
        
        if (!gameState.scenariosCompleted) gameState.scenariosCompleted = 0;
        gameState.scenariosCompleted++;
        
        if (gameState.scenariosCompleted === gameState.totalScenarios) {
          document.getElementById('completeBtn').style.display = 'inline-flex';
          if (!gameState.achievements.includes('scenario_master')) {
            gameState.achievements.push('scenario_master');
            showAchievement('🎯', 'Scenario Master', 'Completed all knowledge checks!');
          }
        }
      } else {
        feedbackDiv.innerHTML = `<div class="feedback incorrect" style="display:block;">
          ❌ ${option.feedback} Try again!
        </div>`;
        // Mark the incorrect button with orange but keep enabled
        buttons[optionIndex].style.opacity = '0.7';
      }
    }
    
    // Navigation
    function updateProgress() {
      document.getElementById('progressBar').style.width = (gameState.currentSlide / gameState.totalSlides) * 100 + '%';
    }
    
    function showSlide(n) {
      document.querySelectorAll('.slide').forEach(slide => slide.classList.remove('active'));
      document.getElementById('slide' + n).classList.add('active');
      gameState.currentSlide = n;
      updateProgress();
      updateSCORM();

      // Notify parent frame if embedded
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'slideChange',
          slide: n,
          module: 'secure-coding'
        }, '*');
      }

      // Auto-complete module when reaching slide 6 (certificate)
      if (n === 6 && !gameState.moduleCompleted) {
        gameState.moduleCompleted = true;
        completeModule();
      }
      
      // Restore choices when reaching decision slides or OWASP slide
      if ([2, 3, 4, 5].includes(n)) {
        if (gameState.choices && Object.keys(gameState.choices).length > 0) {
          setTimeout(restoreChoices, 50);
        }
      }
    }
    
    function nextSlide() {
      if (gameState.currentSlide < gameState.totalSlides) {
        showSlide(gameState.currentSlide + 1);
      }
    }
    
    function previousSlide() {
      if (gameState.currentSlide > 1) {
        showSlide(gameState.currentSlide - 1);
      }
    }
    
    function roleCheck(role) {
      if (role === 'engineer') {
        // Engineers go straight to training
        showAchievement('🚀', 'Training Started!', 'Your secure coding journey begins!');
        nextSlide();
      } else {
        // Non-engineers get a clear popup with overlay
        document.getElementById('skipConfirmation').style.display = 'block';
        document.getElementById('popupOverlay').style.display = 'block';
      }
    }
    
    function skipToCompletion() {
      // Mark training as complete for non-technical roles
      showAchievement('✅', 'Training Complete!', 'Thank you for your commitment to security!');
      gameState.currentSlide = 6; // Jump to certificate
      showSlide(6);
      // Mark as completed
      gameState.trainingComplete = true;
      const finalScore = 100;
      document.getElementById('finalScore').textContent = finalScore + '%';
      
      // Notify parent frame if embedded (for combined training)
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'moduleComplete',
          module: 'secure-coding',
          skipped: true
        }, '*');
      }
      
      // Update SCORM
      if (scorm.api) {
        scorm.set('cmi.score.raw', finalScore);
        scorm.set('cmi.score.min', 0);
        scorm.set('cmi.score.max', 100);
        scorm.set('cmi.completion_status', 'completed');
        scorm.set('cmi.success_status', 'passed');
        scorm.commit();
      }
    }
    
    function startTraining() {
      showAchievement('🚀', 'Training Started!', 'Your secure coding journey begins!');
      nextSlide();
    }
    
    function completeModule() {
      // Mark as complete in SCORM
      if (scorm && scorm.api) {
        scorm.setValue('cmi.core.lesson_status', 'completed');
        scorm.setValue('cmi.core.score.raw', '100');
        scorm.commit();
      }
      
      // Send completion message to parent
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'moduleComplete',
          module: 'secure-coding'
        }, '*');
      }
    }
    
    // Completion
    function completeTraining() {
      
      // Calculate completion score based on simulations only
      let totalActivities = 4; // 4 simulations (USB, Lock, Password, Software)
      let completedActivities = 0;
      
      // Add simulation completions
      if (gameState.ransomwareComplete) completedActivities++;
      if (gameState.lockComplete) completedActivities++;
      if (gameState.passwordComplete) completedActivities++;
      if (gameState.softwareComplete) completedActivities++;
      
      const finalScore = Math.round((completedActivities / totalActivities) * 100);
      
      document.getElementById('finalScore').textContent = finalScore + '%';
      
      // Notify parent frame if embedded
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'moduleComplete',
          module: 'secure-coding'
        }, '*');
      }
      
      // Update SCORM
      scorm.setValue('cmi.core.score.raw', String(finalScore));
      scorm.setValue('cmi.core.lesson_status', finalScore >= 80 ? 'passed' : 'completed');
      scorm.commit();
      
      showSlide(6);
      launchConfetti();
      showAchievement('🏆', 'Training Complete!', 'You are now a Secure Coding Champion!');
    }
    
    function launchConfetti() {
      const container = document.getElementById('confettiContainer');
      container.style.display = 'block';
      const colors = ['#7B2CBF', '#4CAF50', '#FFD700', '#FF6B6B', '#4ECDC4'];
      
      for (let i = 0; i < 100; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.width = (Math.random() * 10 + 5) + 'px';
          confetti.style.height = confetti.style.width;
          confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
          confetti.style.animationDelay = Math.random() * 0.5 + 's';
          container.appendChild(confetti);
          
          setTimeout(() => confetti.remove(), 4000);
        }, i * 30);
      }
    }
    
    // Update SCORM
    // Choice persistence functions
    function saveChoice(slideId, choice) {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'choiceUpdate',
          slideId: slideId,
          choice: choice,
          choicesData: {
            choices: gameState.choices,
            scenariosCompleted: gameState.scenariosCompleted || 0,
            urlsChecked: gameState.urlsChecked || []
          }
        }, '*');
      }
    }
    
    function restoreChoices() {
      const choicesData = gameState.choices || {};
      
      // Restore OWASP exploration state (slide 2)
      if (choicesData['owasp_explored'] && gameState.currentSlide === 2) {
        const owaspExplored = choicesData['owasp_explored'];
        const owaspActive = choicesData['owasp_active'];
        const owaspItems = document.querySelectorAll('.owasp-item');
        
        // Restore explored items
        if (owaspExplored && Array.isArray(owaspExplored)) {
          gameState.owaspExplored = owaspExplored;
          
          owaspExplored.forEach(index => {
            if (owaspItems[index - 1]) {
              owaspItems[index - 1].setAttribute('data-explored', 'true');
            }
          });
          
          // Update counter
          document.getElementById('owaspCount').textContent = owaspExplored.length;
          
          // Show continue button if items explored
          if (owaspExplored.length >= 1) {
            document.getElementById('owaspContinue').style.display = 'inline-flex';
          }
        }
        
        // Restore active/expanded item
        if (owaspActive !== undefined && owaspActive !== null && owaspItems[owaspActive - 1]) {
          gameState.owaspActive = owaspActive;
          owaspItems[owaspActive - 1].classList.add('active');
        }
      }
      
      // Restore SQL injection decision (slide 3)
      if (choicesData['sql_injection_decision'] && gameState.currentSlide === 3) {
        const choice = choicesData['sql_injection_decision'];
        const feedbackDiv = document.getElementById('ransomwareFeedback');
        const buttons = document.querySelectorAll('#slide3 .decision-btn');
        
        // Find the selected button
        let selectedButton = null;
        buttons.forEach(btn => {
          if ((choice === 'validation' && btn.textContent.includes('Missing input validation')) ||
              (choice === 'concatenation' && btn.textContent.includes('String concatenation')) ||
              (choice === 'async' && btn.textContent.includes('async/await')) ||
              (choice === 'password' && btn.textContent.includes('plain text passwords'))) {
            selectedButton = btn;
          }
        });
        
        if (selectedButton && feedbackDiv) {
          // Apply visual restoration
          buttons.forEach(btn => {
            if (btn !== selectedButton) {
              btn.style.opacity = '0.7';
              btn.style.transform = 'scale(0.98)';
            }
          });
          
          const isCorrect = choice === 'concatenation';
          const color = isCorrect ? '#4CAF50' : '#f44336';
          const darkColor = isCorrect ? '#2E7D32' : '#C62828';
          const icon = isCorrect ? '✅' : '❌';
          
          selectedButton.style.background = `linear-gradient(135deg, ${color}, ${darkColor})`;
          selectedButton.style.color = 'white';
          selectedButton.style.fontWeight = 'bold';
          selectedButton.style.border = `4px solid ${darkColor}`;
          selectedButton.style.transform = 'scale(1.12)';
          selectedButton.style.boxShadow = `0 8px 30px ${color}66, 0 0 25px ${color}44`;
          selectedButton.style.opacity = '1';
          selectedButton.style.position = 'relative';
          selectedButton.style.zIndex = '100';
          
          // Remove any existing indicators first
          const existingIndicator = selectedButton.querySelector('.action-indicator');
          if (existingIndicator) existingIndicator.remove();
          const existingLabel = selectedButton.querySelector('.action-label');
          if (existingLabel) existingLabel.remove();
          
          // Add icon and label
          const iconEl = document.createElement('span');
          iconEl.className = 'action-indicator';
          iconEl.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
          iconEl.textContent = icon;
          selectedButton.insertBefore(iconEl, selectedButton.firstChild);
          
          const label = document.createElement('div');
          label.className = 'action-label';
          label.style.cssText = `
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: ${color};
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          `;
          label.textContent = '🎯 YOUR CHOICE';
          selectedButton.appendChild(label);
          
          // Show feedback and restore full state
          if (choice === 'concatenation') {
            feedbackDiv.innerHTML = `<div class="feedback correct" style="display:block;">
              ✅ CORRECT! String concatenation creates SQL injection vulnerabilities!<br><br>
              <strong>The vulnerability:</strong><br>
              • User input is directly concatenated into the SQL query<br>
              • An attacker could pass: <code>admin' OR '1'='1</code><br>
              • This would return ALL users, not just the one with that email<br><br>
              <strong>How to fix:</strong><br>
              • Use parameterized queries: <code>SELECT * FROM users WHERE email = ?</code><br>
              • Use an ORM with built-in protection<br>
              • Never concatenate user input into queries
            </div>`;
            gameState.ransomwareComplete = true;
            // Show continue button
            document.getElementById('ransomwareContinue').style.display = 'inline-flex';
            // Show vulnerability arrow indicator in code
            document.getElementById('vulnerability-arrow').style.display = 'inline';
            // Show SQL demo section
            document.getElementById('sqlDemo').style.display = 'block';
            // Disable all buttons after correct answer
            buttons.forEach(btn => {
              btn.disabled = true;
              btn.classList.add('disabled');
              if (btn !== selectedButton) {
                btn.style.opacity = '0.6';
              }
            });
          } else {
            // Show specific incorrect feedback based on choice
            const incorrectFeedback = {
              'validation': '❌ Input validation helps but is not the root cause. The string concatenation is the vulnerability.',
              'async': '❌ Async/await is perfectly secure. The issue is how the SQL query is constructed.',
              'password': '❌ That\'s another issue, but the immediate SQL injection vulnerability is from string concatenation!'
            };
            feedbackDiv.innerHTML = `<div class="feedback incorrect" style="display:block;">
              ${incorrectFeedback[choice] || '❌ Not the best choice. Try again!'}
            </div>`;
          }
        }
      }
      
      // Restore code review state (slide 4) - Interactive code review
      if (gameState.currentSlide === 4) {
        // Restore analyzed lines
        if (choicesData['code_review_analyzed']) {
          const analyzedLinesArray = choicesData['code_review_analyzed'];
          analyzedLines = new Set(analyzedLinesArray);
          foundIssues = choicesData['code_review_issues'] || [];
          
          // Mark lines as analyzed visually
          analyzedLinesArray.forEach(lineNum => {
            const line = document.querySelectorAll('.code-line')[lineNum];
            if (line) {
              line.classList.add('analyzed');
              const analysis = document.getElementById(`analysis-${lineNum}`);
              if (analysis) {
                analysis.style.display = 'block';
              }
              const indicator = line.querySelector('.line-indicator');
              if (indicator) {
                indicator.style.display = 'inline';
              }
              
              // Apply severity styling
              if (lineNum === 0 || lineNum === 2) {
                line.classList.add('critical');
              } else if (lineNum === 3 || lineNum === 5) {
                line.classList.add('safe');
              } else if (lineNum === 4) {
                // Line 4 uses the hardcoded secret - warning
                line.style.background = 'rgba(255,152,0,0.1)';
                line.style.borderLeft = '3px solid #ff9800';
              }
            }
          });
          
          // Update status
          const totalLines = 6;  // Lines 0-5 are clickable
          document.getElementById('codeReviewStatus').textContent = 
            `Code Review Tool - Analyzed ${analyzedLines.size}/${totalLines} lines`;
          
          // Check if all critical issues were found
          if (foundIssues.includes(0) && foundIssues.includes(2)) {
            document.getElementById('fixMode').disabled = false;
            document.getElementById('lockContinue').style.display = 'inline-flex';
            gameState.lockComplete = true;
          }
        }
        
        // Restore scan results if they were shown
        if (choicesData['code_review_scan_complete']) {
          // Show the scan results directly without animation
          const report = document.getElementById('vulnerabilityReport');
          const reportContent = document.getElementById('reportContent');
          report.style.display = 'block';
          // Restore the full detailed scan results
          reportContent.innerHTML = `
            <div style="display: grid; gap: 16px;">
              <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 12px; border-radius: 4px;">
                <strong style="color: #c62828;">🔴 CRITICAL - CWE-798: Use of Hard-coded Credentials</strong>
                <p style="margin: 8px 0 0 0; color: #666;">Line 1: JWT secret key hardcoded. Impact: Critical</p>
                <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">OWASP: A2:2017 - Broken Authentication</p>
              </div>
              
              <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 12px; border-radius: 4px;">
                <strong style="color: #c62828;">🔴 CRITICAL - CWE-532: Information Exposure Through Log Files</strong>
                <p style="margin: 8px 0 0 0; color: #666;">Line 2: Password and email (PII) logged in plain text. Impact: High</p>
                <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">OWASP: A3:2017 - Sensitive Data Exposure</p>
              </div>
              
              <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; border-radius: 4px;">
                <strong style="color: #f57c00;">⚠️ WARNING - Hardcoded Secret Usage</strong>
                <p style="margin: 8px 0 0 0; color: #666;">Line 4: Using hardcoded JWT_SECRET from line 1</p>
              </div>
              
              <div style="background: #e8f5e9; border-left: 4px solid #4CAF50; padding: 12px; border-radius: 4px;">
                <strong style="color: #2e7d32;">✅ PASS - Secure Password Handling</strong>
                <p style="margin: 8px 0 0 0; color: #666;">Line 3: Using bcrypt for password comparison</p>
              </div>
              
              <div style="margin-top: 16px; padding: 16px; background: #fff3e0; border-radius: 8px;">
                <strong>📊 Scan Summary:</strong>
                <p style="margin: 8px 0 0 0;">• 2 Critical vulnerabilities found</p>
                <p style="margin: 4px 0 0 0;">• Security Score: 40/100</p>
                <p style="margin: 4px 0 0 0;">• Recommendation: Fix critical issues immediately</p>
              </div>
            </div>
          `;
          // Also ensure Fix mode is enabled if scan was complete
          document.getElementById('fixMode').disabled = false;
          
          // Auto-highlight issues in code (same as showScanResults)
          const lines = document.querySelectorAll('.code-line');
          if (lines[0]) lines[0].classList.add('critical');  // JWT_SECRET hardcoded
          if (lines[2]) lines[2].classList.add('critical');  // console.log with password
          if (lines[3]) lines[3].classList.add('safe');     // bcrypt comparison
          if (lines[4]) {
            lines[4].style.background = 'rgba(255,152,0,0.1)';  // Uses hardcoded secret
            lines[4].style.borderLeft = '3px solid #ff9800';
          }
          if (lines[5]) lines[5].classList.add('safe');     // return statement
          
          // Show analyses
          const analysis0 = document.getElementById('analysis-0');
          const analysis2 = document.getElementById('analysis-2');
          const analysis4 = document.getElementById('analysis-4');
          if (analysis0) analysis0.style.display = 'block';
          if (analysis2) analysis2.style.display = 'block';
          if (analysis4) analysis4.style.display = 'block';
        }
        
        // Restore fix panel if it was shown
        if (choicesData['code_review_fixes_shown']) {
          const fixPanel = document.getElementById('fixPanel');
          const fixContent = document.getElementById('fixContent');
          fixPanel.style.display = 'block';
          // Restore the full detailed fix suggestions
          fixContent.innerHTML = `
            <div style="display: grid; gap: 20px;">
              <div>
                <h4 style="color: #c62828; margin-bottom: 8px;">🔧 Fix #1: Remove PII and Passwords from Logs</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div>
                    <strong style="color: #666;">❌ Current (Vulnerable):</strong>
                    <pre style="background: #2d2d2d; color: #ff9999; padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 8px;">
console.log(\`Login for \${email} with password: \${password}\`);</pre>
                  </div>
                  <div>
                    <strong style="color: #2e7d32;">✅ Fixed (Secure):</strong>
                    <pre style="background: #2d2d2d; color: #81c784; padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 8px;">
console.log(\`Login attempt for user ID: \${userId}\`);
// Never log passwords, emails, or other PII!</pre>
                  </div>
                </div>
              </div>
              
              <div>
                <h4 style="color: #c62828; margin-bottom: 8px;">🔧 Fix #2: Use AWS Secrets Manager for Secrets</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div>
                    <strong style="color: #666;">❌ Current (Vulnerable):</strong>
                    <pre style="background: #2d2d2d; color: #ff9999; padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 8px;">
const JWT_SECRET = "secret2024Key!";</pre>
                  </div>
                  <div>
                    <strong style="color: #2e7d32;">✅ Fixed (Secure):</strong>
                    <pre style="background: #2d2d2d; color: #81c784; padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 8px;">
const JWT_SECRET = await secretsManager.getSecret('jwt-secret');
// Managed in AWS Secrets Manager with rotation!</pre>
                  </div>
                </div>
              </div>
              
              <div style="background: #e3f2fd; padding: 16px; border-radius: 8px;">
                <h4 style="color: var(--dark-purple); margin-bottom: 8px;">📚 Security Best Practices Applied:</h4>
                <ul style="margin: 0; padding-left: 20px; color: #666;">
                  <li>Never log sensitive information (passwords, tokens, emails, or PII)</li>
                  <li>Use user IDs instead of email addresses in logs</li>
                  <li>Store secrets in AWS Secrets Manager</li>
                  <li>Enable automatic secret rotation</li>
                  <li>Use structured logging with severity levels</li>
                  <li>Implement audit logging for security events</li>
                </ul>
              </div>
            </div>
          `;
          // Also show the continue button
          document.getElementById('lockContinue').style.display = 'inline-flex';
        }
        
        // Restore review mode - must be done last to set correct button states
        if (choicesData['code_review_mode']) {
          // Don't trigger the mode's actions, just set the visual state
          currentReviewMode = choicesData['code_review_mode'];
          
          // Reset all buttons
          document.getElementById('analyzeMode').style.background = '';
          document.getElementById('analyzeMode').style.color = '';
          document.getElementById('scanMode').style.background = '';
          document.getElementById('scanMode').style.color = '';
          document.getElementById('fixMode').style.background = '';
          document.getElementById('fixMode').style.color = '';
          
          // Set active button
          const modeButton = document.getElementById(currentReviewMode + 'Mode');
          if (modeButton) {
            modeButton.style.background = 'var(--primary-purple)';
            modeButton.style.color = 'white';
          }
          
          // Update status based on mode
          const status = document.getElementById('codeReviewStatus');
          if (currentReviewMode === 'analyze') {
            status.textContent = analyzedLines.size > 0 ? 
              `Code Review Tool - Analyzed ${analyzedLines.size}/6 lines` : 
              'Code Review Tool - Click lines to analyze';
          } else if (currentReviewMode === 'scan' && choicesData['code_review_scan_complete']) {
            status.textContent = 'Security Scan Complete - 2 vulnerabilities found';
          } else if (currentReviewMode === 'fix' && choicesData['code_review_fixes_shown']) {
            status.textContent = 'Fix Mode - Remediation steps shown';
          }
        }
      }
      
      // Restore dependency decision (slide 5)
      if (choicesData['dependency_decision'] && gameState.currentSlide === 5) {
        const choice = choicesData['dependency_decision'];
        const feedbackDiv = document.getElementById('passwordCompleteFeedback');
        const buttons = document.querySelectorAll('#slide5 .decision-btn');
        
        // Find the selected button
        let selectedButton = null;
        buttons.forEach((btn, index) => {
          if ((choice === 'ignore' && index === 0) ||
              (choice === 'later' && index === 1) ||
              (choice === 'update' && index === 2) ||
              (choice === 'research' && index === 3)) {
            selectedButton = btn;
          }
        });
        
        if (selectedButton && feedbackDiv) {
          // Apply visual restoration
          buttons.forEach(btn => {
            if (btn !== selectedButton) {
              btn.style.opacity = '0.7';
              btn.style.transform = 'scale(0.98)';
            }
          });
          
          const isCorrect = choice === 'update';
          const color = isCorrect ? '#4CAF50' : '#f44336';
          const darkColor = isCorrect ? '#2E7D32' : '#C62828';
          const icon = isCorrect ? '✅' : '❌';
          
          selectedButton.style.background = `linear-gradient(135deg, ${color}, ${darkColor})`;
          selectedButton.style.color = 'white';
          selectedButton.style.fontWeight = 'bold';
          selectedButton.style.border = `4px solid ${darkColor}`;
          selectedButton.style.transform = 'scale(1.12)';
          selectedButton.style.boxShadow = `0 8px 30px ${color}66, 0 0 25px ${color}44`;
          selectedButton.style.opacity = '1';
          selectedButton.style.position = 'relative';
          selectedButton.style.zIndex = '100';
          
          // Remove any existing indicators first
          const existingIndicator = selectedButton.querySelector('.action-indicator');
          if (existingIndicator) existingIndicator.remove();
          const existingLabel = selectedButton.querySelector('.action-label');
          if (existingLabel) existingLabel.remove();
          
          // Add icon and label
          const iconEl = document.createElement('span');
          iconEl.className = 'action-indicator';
          iconEl.style.cssText = 'margin-right: 12px; font-size: 1.6em; vertical-align: middle;';
          iconEl.textContent = icon;
          selectedButton.insertBefore(iconEl, selectedButton.firstChild);
          
          const label = document.createElement('div');
          label.className = 'action-label';
          label.style.cssText = `
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: ${color};
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          `;
          label.textContent = '🎯 YOUR CHOICE';
          selectedButton.appendChild(label);
          
          // Show feedback
          if (choice === 'update') {
            feedbackDiv.innerHTML = `<div class="feedback correct" style="display:block;">
              ✅ CORRECT! Critical vulnerabilities must be patched immediately!
            </div>`;
            gameState.passwordComplete = true;
            // Show continue button
            document.getElementById('passwordContinue').style.display = 'inline-flex';
            // Disable all buttons after correct answer
            buttons.forEach(btn => {
              btn.disabled = true;
              if (btn !== selectedButton) {
                btn.style.opacity = '0.6';
              }
            });
          } else {
            feedbackDiv.innerHTML = `<div class="feedback incorrect" style="display:block;">
              ❌ Not the best choice. Try again!
            </div>`;
          }
        }
      }
    }
    
    function updateSCORM() {
      if (scorm.api) {
        scorm.setValue('cmi.core.lesson_location', String(gameState.currentSlide));
        scorm.setValue('cmi.suspend_data', JSON.stringify({
          currentSlide: gameState.currentSlide,
          achievements: gameState.achievements
        }));
        scorm.commit();
      }
    }
    
    // Initialize
    window.onload = function() {

      // Check if SCORM should be disabled (when loaded in iframe)
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('scorm') !== 'disabled') {
        scorm.init();
      }

      // Check if module is in review mode (already completed)
      const reviewMode = urlParams.get('reviewMode');
      if (reviewMode === 'true') {
        gameState.moduleCompleted = true;
      }

      // Check if we should resume from a specific slide
      const resumeSlide = urlParams.get('slide');
      if (resumeSlide && !isNaN(resumeSlide)) {
        gameState.currentSlide = parseInt(resumeSlide);
        // Show the correct slide immediately to avoid flash
        showSlide(gameState.currentSlide);
      }


      // Restore choices if provided
      const savedChoices = urlParams.get('choices');
      if (savedChoices) {
        try {
          const choicesData = JSON.parse(decodeURIComponent(savedChoices));
          if (choicesData.choices !== undefined) {
            gameState.choices = choicesData.choices;
            gameState.scenariosCompleted = choicesData.scenariosCompleted || 0;
            // Don't restore urlsChecked here - it will be rebuilt from choices
          } else {
            gameState.choices = choicesData;
          }
          // Don't restore here - will be done when reaching the specific slide
        } catch (e) {
          console.warn('Failed to parse saved choices:', e);
        }
      }

      updateProgress();
      updateSCORM();

      // If we're resuming on a slide with choices or OWASP, restore them with minimal delay
      if ((gameState.currentSlide === 2 || gameState.currentSlide === 3 || gameState.currentSlide === 4 || gameState.currentSlide === 5) && savedChoices) {
        setTimeout(restoreChoices, 50);
      }
    };
    
    // Owl easter egg
    function owlClick() {
      const owl = document.querySelector('.grc-owl');
      owl.style.animation = 'none';
      setTimeout(() => {
        owl.style.animation = 'bounce 2s ease-in-out infinite, spin 0.5s ease';
      }, 10);
      if (!gameState.achievements.includes('owl')) {
        gameState.achievements.push('owl');
        showAchievement('👾', 'Wise Discovery!', 'You found the easter egg!');
      }
      // If in iframe, send message to parent to go home
      if (window.parent !== window) {
        window.parent.postMessage({ type: 'goHome' }, '*');
      }
    }
    
    // Listen for messages from parent frame
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'restoreState' && e.data.module === 'secure-coding') {
        // Restore choices from parent
        if (e.data.choices) {
          gameState.choices = e.data.choices;
        }
        
        // Navigate to the saved slide if provided
        if (e.data.slide && e.data.slide !== gameState.currentSlide) {
          showSlide(e.data.slide);
        }
        
        // Restore choices after a short delay to ensure DOM is ready
        setTimeout(() => {
          restoreChoices();
        }, 100);
      }
    });
  </script>
</body>
</html>